{% extends 'practitionerdashboard/base.html' %}
{% load static %}

{% block title %}
    Patient Messages - Practitioner Dashboard
{% endblock %}

{% block content %}
<style>
/* Custom styles for practitioner chat */
.chat-container {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: calc(100vh - 200px);
}

.chat-sidebar {
    background: white;
    border-right: 2px solid #e2e8f0;
}

.chat-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 12px;
    margin: 4px 8px;
}

.chat-item:hover {
    background: #f1f5f9;
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.chat-item.active {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    transform: translateX(8px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
}

.chat-item.active h3,
.chat-item.active p,
.chat-item.active span {
    color: white !important;
}

.chat-area {
    background: white;
    position: relative;
}

.search-input {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
}

.search-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    background: white;
}

.loading-overlay {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(4px);
}

.patient-avatar {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.online-indicator {
    background: #10b981;
    box-shadow: 0 0 0 2px white;
}

.unread-badge {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

.welcome-area {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
}

.welcome-icon {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

/* Mobile-first responsive design */
@media (max-width: 767px) {
    .chat-container {
        height: calc(100vh - 120px) !important;
        margin: 0 -1rem;
    }
    
    .chat-interface {
        border-radius: 0 !important;
        height: 100% !important;
    }
    
    .chat-sidebar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100%;
        background: white;
        z-index: 20;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
    }
    
    .chat-sidebar.show {
        transform: translateX(0);
    }
    
    .chat-area {
        width: 100% !important;
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
    }
    
    .message-bubble {
        max-width: 85% !important;
    }
}

@media (max-width: 640px) {
    .message-bubble {
        max-width: 90% !important;
        font-size: 0.875rem;
    }
    
    .chat-input {
        font-size: 16px !important;
    }
}
</style>

<!-- Modern Chat Interface -->
<div class="chat-container p-6">
    <!-- Header Section -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-comments text-blue-600 mr-3"></i>
                    Patient Messages
                </h1>
                <p class="text-gray-600">Communicate securely with your patients</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-semibold">
                    <i class="fas fa-circle text-green-500 mr-2"></i>
                    Online
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden" style="height: 650px;">
        <div class="flex h-full relative">
            <!-- Chat List Sidebar -->
            <div class="w-full md:w-96 chat-sidebar flex flex-col transition-transform duration-300 ease-in-out md:translate-x-0" 
                 id="chat-sidebar"
                 style="z-index: 10;">
                <!-- Search -->
                <div class="p-4 border-b border-gray-200 bg-gray-50">
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" 
                               placeholder="Search patients..." 
                               class="search-input w-full pl-12 pr-4 py-3 rounded-xl focus:outline-none transition-all duration-300"
                               id="search-input">
                    </div>
                </div>

                <!-- Chat List -->
                <div class="flex-1 overflow-y-auto bg-gray-50">
                    {% if chat_rooms %}
                        <div class="py-2">
                            {% for room in chat_rooms %}
                            <div class="chat-item p-4 cursor-pointer {% if room.id == active_room_id %}active{% endif %}"
                                 onclick="loadChatRoom({{ room.id }})"
                                 data-room-id="{{ room.id }}"
                                 role="button"
                                 tabindex="0"
                                 title="Chat with {{ room.patient.first_name }} {{ room.patient.last_name }}">
                                <div class="flex items-center space-x-3">
                                    <!-- Profile Photo -->
                                    <div class="relative flex-shrink-0">
                                        {% if room.patient.profile_photo %}
                                            <img src="{{ room.patient.profile_photo.url }}" 
                                                 alt="{{ room.patient.first_name }}"
                                                 class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-md">
                                        {% else %}
                                            <div class="patient-avatar w-12 h-12 rounded-full flex items-center justify-center text-white font-bold shadow-md">
                                                {{ room.patient.first_name|slice:":1"|upper }}{{ room.patient.last_name|slice:":1"|upper }}
                                            </div>
                                        {% endif %}
                                        <!-- Online Status -->
                                        <div class="online-indicator absolute -bottom-1 -right-1 w-4 h-4 rounded-full"></div>
                                    </div>
                                    
                                    <!-- Chat Info -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between mb-1">
                                            <h3 class="font-semibold text-gray-900 truncate text-sm">
                                                {{ room.patient.first_name }} {{ room.patient.last_name }}
                                            </h3>
                                            {% with last_message=room.last_messages.0 %}
                                                {% if last_message %}
                                                    <span class="text-xs text-gray-500 flex-shrink-0">
                                                        {{ last_message.timestamp|timesince }} ago
                                                    </span>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                        
                                        <div class="flex items-center justify-between">
                                            <!-- Last Message Preview -->
                                            {% with last_message=room.last_messages.0 %}
                                                {% if last_message %}
                                                    <p class="text-xs text-gray-600 truncate flex-1">
                                                        {% if last_message.sender_type == 'practitioner' %}
                                                            <span class="text-blue-600 font-medium">You:</span>
                                                        {% endif %}
                                                        {{ last_message.content }}
                                                    </p>
                                                {% else %}
                                                    <p class="text-xs text-gray-400 italic">No messages yet</p>
                                                {% endif %}
                                            {% endwith %}
                                            
                                            <!-- Unread Count -->
                                            {% if room.unread_count > 0 %}
                                                <span class="unread-badge ml-2 text-white text-xs px-2 py-1 rounded-full font-bold flex-shrink-0">
                                                    {{ room.unread_count }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Patient Info -->
                                        <div class="mt-1">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">
                                                <i class="fas fa-user-injured mr-1"></i>
                                                Patient
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="flex flex-col items-center justify-center h-full p-8 text-center">
                            <div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-inbox text-3xl text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">No Patient Messages</h3>
                            <p class="text-gray-500 text-sm">Patients will appear here when they message you</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col chat-area md:relative absolute inset-0 md:inset-auto" id="chat-area">
                <div id="chat-room-container" class="flex-1 flex flex-col">
                    {% if active_room_id %}
                        {% include "chat/chat_room_content.html" %}
                    {% else %}
                        <div class="welcome-area flex-1 flex flex-col items-center justify-center p-8 text-center">
                            <div class="welcome-icon w-32 h-32 rounded-full flex items-center justify-center mb-6 shadow-xl">
                                <i class="fas fa-stethoscope text-4xl text-white"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-3">Patient Communication Center</h2>
                            <p class="text-gray-600 mb-6 max-w-md leading-relaxed">
                                Select a patient conversation from the left to view and respond to messages securely.
                            </p>
                            <div class="flex items-center space-x-2 text-sm text-gray-500 bg-white px-4 py-2 rounded-full shadow-md">
                                <i class="fas fa-shield-alt text-green-500"></i>
                                <span>HIPAA Compliant & Secure</span>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-700 font-semibold text-lg">Loading conversation...</p>
        <p class="text-gray-500 text-sm mt-2">Please wait while we fetch the messages</p>
    </div>
</div>

<script>
// Simplified Chat functionality for practitioners (matching patient template)
const userType = 'practitioner';
const userColorClass = 'doctor';
let showSidebar = window.innerWidth >= 768;
let currentRoomId = {% if active_room_id %}{{ active_room_id }}{% else %}null{% endif %};

// Handle window resize
window.addEventListener('resize', function() {
    const sidebar = document.getElementById('chat-sidebar');
    const chatArea = document.getElementById('chat-area');
    
    if (window.innerWidth >= 768) {
        // Desktop view
        showSidebar = true;
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('translate-x-0');
        chatArea.classList.remove('hidden');
    } else {
        // Mobile view - show sidebar if no active room, otherwise show chat
        if (currentRoomId) {
            showSidebar = false;
            sidebar.classList.add('-translate-x-full');
            chatArea.classList.remove('hidden');
        } else {
            showSidebar = true;
            sidebar.classList.remove('-translate-x-full');
            chatArea.classList.add('hidden');
        }
    }
});

// Add global function for mobile back button
window.goBackToSidebar = function() {
    if (window.innerWidth < 768) {
        const sidebar = document.getElementById('chat-sidebar');
        const chatArea = document.getElementById('chat-area');
        
        if (sidebar && chatArea) {
            showSidebar = true;
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            chatArea.classList.add('hidden');
        }
    }
};

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const name = item.querySelector('h3').textContent.toLowerCase();
                const message = item.querySelector('p').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || message.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Initialize chat room if active
    {% if active_room_id %}
        initializeChatRoom();
    {% endif %}
    
    console.log('âœ… Practitioner chat system initialized');
});

// Load chat room function
function loadChatRoom(roomId) {
    console.log('ðŸ¥ Loading practitioner chat room:', roomId);
    
    // Show loading
    showLoadingModal();
    
    // Update active state
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Set active state for clicked item
    const clickedItem = document.querySelector(`[data-room-id="${roomId}"]`);
    if (clickedItem) {
        clickedItem.classList.add('active');
    }
    
    // On mobile, hide sidebar when loading chat
    if (window.innerWidth < 768) {
        showSidebar = false;
        const sidebar = document.getElementById('chat-sidebar');
        const chatArea = document.getElementById('chat-area');
        sidebar.classList.add('-translate-x-full');
        chatArea.classList.remove('hidden');
    }
    
    // Load chat room content
    fetch(`/chat/room/${roomId}/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.text();
    })
    .then(html => {
        hideLoadingModal();
        const chatContainer = document.getElementById('chat-room-container');
        if (chatContainer) {
            chatContainer.innerHTML = html;
            currentRoomId = roomId;
            
            // Update URL without page reload
            window.history.pushState({}, '', `/chat/room/${roomId}/`);
            
            // Initialize chat functionality
            initializeChatRoom();
            
            // Update unread count in sidebar
            updateUnreadCount(roomId);
            
            console.log('âœ… Practitioner chat room loaded successfully');
        }
    })
    .catch(error => {
        hideLoadingModal();
        console.error('âŒ Error loading chat:', error);
        showNotification('Error loading conversation', 'error');
    });
}

// Initialize chat room functionality
function initializeChatRoom() {
    // Scroll to bottom of messages
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Focus on message input
    const messageInput = document.getElementById('chat-message-input');
    if (messageInput) {
        messageInput.focus();
    }
    
    console.log('ðŸŽ¯ Practitioner chat room initialized');
}

// Update unread count
function updateUnreadCount(roomId) {
    const chatItem = document.querySelector(`[data-room-id="${roomId}"]`);
    if (chatItem) {
        const unreadBadge = chatItem.querySelector('.unread-badge');
        if (unreadBadge) {
            unreadBadge.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => unreadBadge.remove(), 300);
        }
    }
}

// Utility functions
function showLoadingModal() {
    let modal = document.getElementById('loadingModal');
    if (!modal) {
        // Create loading modal if it doesn't exist
        modal = document.createElement('div');
        modal.id = 'loadingModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl p-8 text-center shadow-2xl">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-700 font-semibold text-lg">Loading conversation...</p>
                <p class="text-gray-500 text-sm mt-2">Please wait while we fetch the messages</p>
            </div>
        `;
        document.body.appendChild(modal);
    }
    modal.classList.remove('hidden');
}

function hideLoadingModal() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function showNotification(message, type = 'info') {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    };
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform translate-x-full transition-all duration-300`;
    notification.innerHTML = `
        <div class="flex items-center space-x-3">
            <i class="fas ${icons[type]} text-lg"></i>
            <span class="font-medium">${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    
    // Animate out and remove
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Auto-refresh chat list every 30 seconds
setInterval(() => {
    // Refresh unread counts without reloading the page
    fetch(window.location.href, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Update only the chat list part
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newChatList = doc.querySelector('#chat-sidebar');
        const currentChatList = document.querySelector('#chat-sidebar');
        
        if (newChatList && currentChatList) {
            // Preserve search input value
            const searchInput = document.getElementById('search-input');
            const searchValue = searchInput ? searchInput.value : '';
            currentChatList.innerHTML = newChatList.innerHTML;
            
            // Restore search value and re-attach event listener
            const newSearchInput = document.getElementById('search-input');
            if (newSearchInput) {
                newSearchInput.value = searchValue;
                newSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const chatItems = document.querySelectorAll('.chat-item');
                    
                    chatItems.forEach(item => {
                        const name = item.querySelector('h3').textContent.toLowerCase();
                        const message = item.querySelector('p').textContent.toLowerCase();
                        
                        if (name.includes(searchTerm) || message.includes(searchTerm)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
            
            // Restore active state
            if (currentRoomId) {
                const activeItem = document.querySelector(`[data-room-id="${currentRoomId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }
    })
    .catch(error => {
        console.log('Auto-refresh failed:', error);
    });
}, 30000);
</script>

{% endblock content %}