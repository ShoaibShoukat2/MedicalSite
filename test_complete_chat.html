<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Chat System Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Enhanced Message Bubble Styles */
        .message-bubble-sent {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .message-bubble-received {
            background: #F8FAFC;
            color: #374151;
            border: 1px solid #E2E8F0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .patient-sent {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .doctor-sent, .practitioner-sent {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Enhanced animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-slide-up {
            animation: slideInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Typing animation */
        @keyframes typing {
            0%, 60%, 100% { 
                transform: translateY(0); 
                opacity: 0.4; 
            }
            30% { 
                transform: translateY(-6px); 
                opacity: 1; 
            }
        }

        .animate-typing {
            animation: typing 1.4s infinite;
        }

        /* Send button animation */
        @keyframes sendPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .send-pulse {
            animation: sendPulse 0.3s ease-in-out;
        }

        /* Improved scrollbar */
        .scrollbar-thin {
            scrollbar-width: thin;
            scrollbar-color: #CBD5E1 #F1F5F9;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #F1F5F9;
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #94A3B8;
        }

        /* Input focus effects */
        .chat-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            border-color: #3B82F6;
        }

        /* Loading states */
        .message-loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .message-error {
            background: #FEE2E2 !important;
            border: 1px solid #FECACA !important;
            color: #DC2626 !important;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 100px) !important;
            }
            
            .message-bubble {
                max-width: 85% !important;
            }
            
            .chat-input {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-comments text-blue-600 mr-3"></i>
                        Complete Chat System Test
                    </h1>
                    <p class="text-gray-600">Testing all chat functionality with animations and message handling</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-semibold">
                        <i class="fas fa-circle text-green-500 mr-2"></i>
                        <span id="connection-status">Connected</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden chat-container" style="height: 70vh;">
            <div class="flex h-full">
                <!-- Chat List Sidebar -->
                <div class="w-80 border-r border-gray-200 flex flex-col bg-gray-50">
                    <!-- Search -->
                    <div class="p-4 border-b border-gray-200">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" 
                                   placeholder="Search conversations..." 
                                   class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-300"
                                   id="search-input">
                        </div>
                    </div>

                    <!-- Chat List -->
                    <div class="flex-1 overflow-y-auto p-2">
                        <!-- Sample Chat Items -->
                        <div class="chat-item p-4 rounded-xl hover:bg-white transition-all duration-300 cursor-pointer border-l-4 border-transparent hover:border-blue-500 active bg-blue-50 border-blue-500"
                             onclick="selectChat('Dr. John Smith', 'patient')"
                             data-chat-id="1">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold shadow-sm">
                                    JS
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-1">
                                        <h3 class="font-semibold text-gray-900 truncate text-sm">Dr. John Smith</h3>
                                        <span class="text-xs text-gray-500">2 min ago</span>
                                    </div>
                                    <p class="text-xs text-gray-600 truncate">How are you feeling today?</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-item p-4 rounded-xl hover:bg-white transition-all duration-300 cursor-pointer border-l-4 border-transparent hover:border-green-500"
                             onclick="selectChat('Dr. Sarah Johnson', 'practitioner')"
                             data-chat-id="2">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center text-white font-bold shadow-sm">
                                    SJ
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-1">
                                        <h3 class="font-semibold text-gray-900 truncate text-sm">Dr. Sarah Johnson</h3>
                                        <span class="text-xs text-gray-500">1 hour ago</span>
                                    </div>
                                    <p class="text-xs text-gray-600 truncate">Your test results are ready</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="flex-1 flex flex-col">
                    <!-- Chat Header -->
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white font-bold">
                                <span id="chat-avatar">JS</span>
                            </div>
                            <div>
                                <h2 class="font-bold text-lg" id="chat-name">Dr. John Smith</h2>
                                <div class="flex items-center space-x-2 text-sm opacity-90">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span>Online</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all duration-300" title="Video Call">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all duration-300" title="Voice Call">
                                <i class="fas fa-phone"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin bg-gradient-to-b from-gray-50 to-white" id="messages-container">
                        <!-- Messages will be added here -->
                    </div>

                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="hidden px-4 pb-2">
                        <div class="flex justify-start">
                            <div class="max-w-xs lg:max-w-md">
                                <div class="bg-white border border-gray-200 rounded-2xl rounded-bl-md px-4 py-3 shadow-sm">
                                    <div class="flex space-x-1 items-center">
                                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-typing"></div>
                                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-typing" style="animation-delay: 0.2s"></div>
                                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-typing" style="animation-delay: 0.4s"></div>
                                    </div>
                                </div>
                                <div class="flex justify-start mt-1">
                                    <span class="text-xs text-gray-500 italic">typing...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="bg-white border-t border-gray-200 p-4 shadow-lg">
                        <form id="chat-form" class="flex items-end space-x-3">
                            <div class="flex-1 relative">
                                <input type="text" 
                                       id="message-input" 
                                       placeholder="Type your message..." 
                                       class="chat-input w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-300 pr-16 text-base"
                                       autocomplete="off"
                                       maxlength="1000">
                                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
                                    <span class="text-xs text-gray-400" id="char-counter">0/1000</span>
                                    <button type="button" class="w-6 h-6 bg-transparent rounded-full flex items-center justify-center hover:bg-gray-200 transition-all duration-300" title="Add Emoji">
                                        <i class="fas fa-smile text-xs text-gray-400 hover:text-yellow-500 transition-colors duration-300"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button type="submit" 
                                    id="send-button"
                                    class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-full flex items-center justify-center hover:shadow-lg transform hover:scale-105 active:scale-95 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-paper-plane text-lg"></i>
                            </button>
                        </form>
                        
                        <!-- Quick Replies -->
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button class="quick-reply-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-blue-500 hover:text-white transition-all duration-300 transform hover:scale-105" data-message="Thank you!">
                                <i class="fas fa-thumbs-up mr-1"></i>Thank you!
                            </button>
                            <button class="quick-reply-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-green-500 hover:text-white transition-all duration-300 transform hover:scale-105" data-message="I understand">
                                <i class="fas fa-check mr-1"></i>I understand
                            </button>
                            <button class="quick-reply-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-purple-500 hover:text-white transition-all duration-300 transform hover:scale-105" data-message="Can we schedule a call?">
                                <i class="fas fa-phone mr-1"></i>Schedule call
                            </button>
                            <button class="quick-reply-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-orange-500 hover:text-white transition-all duration-300 transform hover:scale-105" data-message="I have a question">
                                <i class="fas fa-question-circle mr-1"></i>Question
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="mt-6 bg-white rounded-xl shadow-lg p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div class="bg-blue-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-blue-600" id="message-count">0</div>
                    <div class="text-sm text-gray-600">Messages</div>
                </div>
                <div class="bg-green-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-green-600" id="sent-count">0</div>
                    <div class="text-sm text-gray-600">Sent</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-purple-600" id="received-count">0</div>
                    <div class="text-sm text-gray-600">Received</div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-3">
                    <div class="text-sm font-semibold text-yellow-800" id="last-action">Ready</div>
                    <div class="text-sm text-gray-600">Status</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let messageCount = 0;
        let sentCount = 0;
        let receivedCount = 0;
        let isSending = false;
        let isConnected = true;
        let currentUserType = 'patient';

        // DOM elements
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages-container');
        const sendButton = document.getElementById('send-button');
        const charCounter = document.getElementById('char-counter');
        const typingIndicator = document.getElementById('typing-indicator');
        const connectionStatus = document.getElementById('connection-status');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… Complete chat system loaded');
            updateLastAction('System initialized');
            
            // Add welcome messages
            addMessage(false, "Hello! How can I help you today?");
            addMessage(true, "Hi doctor, I have a question about my medication.");
            addMessage(false, "Of course! What would you like to know?");
            
            // Focus on input
            messageInput.focus();
        });

        // Character counter
        messageInput.addEventListener('input', function() {
            const length = this.value.length;
            charCounter.textContent = `${length}/1000`;
            charCounter.className = length > 900 ? 'text-xs text-red-500' : 'text-xs text-gray-400';
        });

        // Form submission handler
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!messageInput || !isConnected || isSending) {
                console.log('âš ï¸ Cannot send: form not ready or already sending');
                return;
            }

            const message = messageInput.value.trim();
            
            if (!message) {
                console.log('âš ï¸ Cannot send empty message');
                return;
            }
            
            if (message.length > 1000) {
                showNotification('Message too long (max 1000 characters)', 'error');
                return;
            }
            
            console.log('ðŸ“¤ Sending message:', message.substring(0, 50) + '...');
            
            // Store original button content and disable form
            const originalButtonContent = sendButton.innerHTML;
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin text-lg"></i>';
            sendButton.classList.add('send-pulse');
            
            // Clear input immediately to prevent double sending
            const messageToSend = message;
            messageInput.value = '';
            charCounter.textContent = '0/1000';
            charCounter.className = 'text-xs text-gray-400';
            
            // Simulate sending
            isSending = true;
            updateLastAction('Sending message...');
            
            try {
                // Add message to UI
                addMessage(true, messageToSend);
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Simulate success
                showNotification('Message sent', 'success');
                updateLastAction('Message sent successfully');
                
                // Simulate response
                setTimeout(() => {
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        const responses = [
                            "I understand your concern.",
                            "That's a good question.",
                            "Let me help you with that.",
                            "I see what you mean.",
                            "Thank you for sharing that information."
                        ];
                        const response = responses[Math.floor(Math.random() * responses.length)];
                        addMessage(false, response);
                        updateLastAction('Received response');
                    }, 2000);
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Error sending message:', error);
                showNotification('Failed to send message', 'error');
                updateLastAction('Send failed');
                
                // Restore message to input on failure
                messageInput.value = messageToSend;
                charCounter.textContent = `${messageToSend.length}/1000`;
                charCounter.className = messageToSend.length > 900 ? 'text-xs text-red-500' : 'text-xs text-gray-400';
            } finally {
                // Re-enable form
                isSending = false;
                sendButton.disabled = false;
                sendButton.innerHTML = originalButtonContent;
                sendButton.classList.remove('send-pulse');
                
                // Focus back on input
                setTimeout(() => {
                    if (messageInput) {
                        messageInput.focus();
                    }
                }, 100);
            }
        });

        // Quick replies handler
        document.querySelectorAll('.quick-reply-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const message = this.getAttribute('data-message');
                if (message && !isSending && messageInput) {
                    console.log('ðŸ”„ Quick reply selected:', message);
                    messageInput.value = message;
                    messageInput.focus();
                    
                    // Update character counter
                    charCounter.textContent = `${message.length}/1000`;
                    charCounter.className = message.length > 900 ? 'text-xs text-red-500' : 'text-xs text-gray-400';
                    
                    // Auto-send quick replies after a short delay
                    setTimeout(() => {
                        if (chatForm && !isSending) {
                            const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                            chatForm.dispatchEvent(submitEvent);
                        }
                    }, 200);
                }
            });
        });

        // Enter key to send
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !isSending) {
                e.preventDefault();
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                chatForm.dispatchEvent(submitEvent);
            }
        });

        // Chat selection
        function selectChat(name, userType) {
            document.getElementById('chat-name').textContent = name;
            document.getElementById('chat-avatar').textContent = name.split(' ').map(n => n[0]).join('');
            currentUserType = userType;
            
            // Update active state
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active', 'bg-blue-50', 'border-blue-500');
                item.classList.add('border-transparent');
            });
            
            event.currentTarget.classList.add('active', 'bg-blue-50', 'border-blue-500');
            event.currentTarget.classList.remove('border-transparent');
            
            updateLastAction(`Selected chat with ${name}`);
        }

        // Add message to UI
        function addMessage(isSent, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-item animate-slide-up ${isSent ? 'flex justify-end' : 'flex justify-start'}`;
            
            const currentTime = new Date().toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: 'numeric', 
                hour12: true 
            });

            const bubbleClass = isSent 
                ? `message-bubble-sent ${currentUserType}-sent text-white rounded-2xl rounded-br-md`
                : 'message-bubble-received bg-white border border-gray-200 text-gray-800 rounded-2xl rounded-bl-md';

            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                    <div class="${bubbleClass} px-4 py-3 shadow-lg transform hover:scale-[1.02] transition-all duration-300">
                        <p class="text-sm leading-relaxed break-words">${escapeHtml(content)}</p>
                    </div>
                    <div class="flex ${isSent ? 'justify-end' : 'justify-start'} mt-1 items-center space-x-1">
                        <span class="text-xs text-gray-500">${currentTime}</span>
                        ${isSent ? '<i class="fas fa-check-double text-blue-500 text-xs" title="Delivered"></i>' : ''}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            messageCount++;
            if (isSent) {
                sentCount++;
            } else {
                receivedCount++;
            }
            updateCounters();
        }

        // Show/hide typing indicator
        function showTyping() {
            typingIndicator.classList.remove('hidden');
            scrollToBottom();
            updateLastAction('Other user is typing...');
        }

        function hideTyping() {
            typingIndicator.classList.add('hidden');
        }

        // Utility functions
        function scrollToBottom() {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function updateCounters() {
            document.getElementById('message-count').textContent = messageCount;
            document.getElementById('sent-count').textContent = sentCount;
            document.getElementById('received-count').textContent = receivedCount;
        }

        function updateLastAction(action) {
            document.getElementById('last-action').textContent = action;
            console.log(`ðŸ”§ Status: ${action}`);
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform translate-x-full transition-all duration-300`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas ${icons[type]} text-lg"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>