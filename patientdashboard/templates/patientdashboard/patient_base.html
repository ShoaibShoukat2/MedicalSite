<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/favicon.ico' %}">
    <title>{% block title %}Patient Dashboard{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'patient-blue': '#0066CC',
                        'patient-light-blue': '#E6F3FF',
                        'patient-dark-blue': '#004499',
                        'patient-green': '#00A86B',
                        'patient-light-green': '#E8F5E8',
                        'patient-teal': '#008B8B',
                        'patient-gray': '#F8FAFC',
                        'patient-dark-gray': '#64748B',
                        'patient-red': '#DC2626',
                        'patient-orange': '#EA580C',
                        'patient-purple': '#7C3AED',
                        'patient-pink': '#EC4899'
                    },
                    fontFamily: {
                        'patient': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'bounce-gentle': 'bounceGentle 2s infinite',
                    }
                }
            }
        }
    </script>

    {% block extra_css %}{% endblock %}
    <style>
        /* Modern Patient Dashboard Styles */
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #F8FAFC 0%, #E6F3FF 100%);
        }
        
        /* Sidebar Animations */
        .sidebar-enter {
            transform: translateX(-100%);
        }
        
        .sidebar-enter-active {
            transform: translateX(0);
            transition: transform 0.3s ease-out;
        }
        
        .sidebar-exit {
            transform: translateX(0);
        }
        
        .sidebar-exit-active {
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
        }
        
        /* Card Hover Effects */
        .patient-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .patient-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 102, 204, 0.15);
        }
        
        /* Medical Pulse Animation */
        .medical-pulse {
            animation: medicalPulse 2s infinite;
        }
        
        @keyframes medicalPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.4);
            }
            50% {
                box-shadow: 0 0 0 15px rgba(0, 102, 204, 0);
            }
        }
        
        /* Notification Badge */
        .notification-badge {
            animation: notificationBounce 2s infinite;
        }
        
        @keyframes notificationBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-3px);
            }
            60% {
                transform: translateY(-1px);
            }
        }
        
        /* Notification Panel Animations */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Prevent notification panel from affecting layout */
        #notificationPanel {
            transform-origin: top right;
        }
        
        /* Header positioning fix */
        header {
            position: relative;
            z-index: 1000;
        }
        
        /* Notification System Z-Index Fix */
        #notificationDropdown {
            position: relative;
            z-index: 5000;
        }
        
        #notificationPanel {
            position: absolute !important;
            z-index: 5000 !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
            min-width: 320px;
            max-width: 90vw;
        }
        
        /* Responsive notification panel */
        @media (max-width: 640px) {
            #notificationPanel {
                right: -16px !important;
                width: calc(100vw - 32px) !important;
                max-width: none !important;
            }
        }
        
        /* Ensure notification panel appears above sidebar and other elements */
        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10004;
            background: transparent;
            pointer-events: none;
        }
        
        .notification-overlay.active {
            pointer-events: auto;
        }
        
        /* Notification Color Classes */
        .notification-icon-patient-blue { background-color: rgba(0, 102, 204, 0.1); }
        .notification-text-patient-blue { color: #0066CC; }
        .notification-bg-patient-blue { background-color: #0066CC; }
        
        .notification-icon-patient-green { background-color: rgba(0, 168, 107, 0.1); }
        .notification-text-patient-green { color: #00A86B; }
        .notification-bg-patient-green { background-color: #00A86B; }
        
        .notification-icon-patient-orange { background-color: rgba(234, 88, 12, 0.1); }
        .notification-text-patient-orange { color: #EA580C; }
        .notification-bg-patient-orange { background-color: #EA580C; }
        
        .notification-icon-patient-purple { background-color: rgba(124, 58, 237, 0.1); }
        .notification-text-patient-purple { color: #7C3AED; }
        .notification-bg-patient-purple { background-color: #7C3AED; }
        
        .notification-icon-patient-teal { background-color: rgba(0, 139, 139, 0.1); }
        .notification-text-patient-teal { color: #008B8B; }
        .notification-bg-patient-teal { background-color: #008B8B; }
        
        /* Smooth Transitions */
        .smooth-transition {
            transition: all 0.3s ease;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #0066CC;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #004499;
        }
        
        /* Language Dropdown Specific Styles */
        .language-selector-container {
            position: relative !important;
            z-index: 10000 !important;
            display: inline-block !important;
        }
        
        #languageSelector {
            position: relative !important;
            z-index: 10000 !important;
            display: flex !important;
            align-items: center !important;
            min-width: 44px !important;
            min-height: 44px !important;
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.2) !important;
            transition: all 0.3s ease !important;
        }
        
        #languageSelector:hover {
            box-shadow: 0 8px 25px rgba(0, 102, 204, 0.3) !important;
            transform: translateY(-1px) !important;
        }
        
        #languageDropdown {
            position: absolute !important;
            top: calc(100% + 0.75rem) !important;
            right: 0 !important;
            left: auto !important;
            z-index: 99999 !important;
            width: 16rem !important;
            max-width: calc(100vw - 2rem) !important;
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(20px) !important;
            border-radius: 1rem !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(229, 231, 235, 0.5) !important;
            transform-origin: top right !important;
            opacity: 0 !important;
            transform: scale(0.95) translateY(-10px) !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            pointer-events: none !important;
        }
        
        #languageDropdown:not(.hidden) {
            opacity: 1 !important;
            transform: scale(1) translateY(0) !important;
            pointer-events: auto !important;
        }
        
        /* Language option hover effects */
        .language-option {
            transition: all 0.2s ease !important;
            border-radius: 0.75rem !important;
            margin: 0.25rem !important;
        }
        
        .language-option:hover {
            transform: translateX(4px) !important;
            background: linear-gradient(135deg, #E6F3FF 0%, #F0F8FF 100%) !important;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #languageDropdown {
                right: -1rem !important;
                width: calc(100vw - 2rem) !important;
                max-width: 20rem !important;
            }
            
            #languageSelector {
                padding: 0.5rem !important;
                min-width: 40px !important;
            }
            
            #languageSelector span {
                display: none !important;
            }
        }
        
        @media (max-width: 640px) {
            #languageDropdown {
                right: -0.5rem !important;
                width: calc(100vw - 1rem) !important;
            }
        }
        
        /* Responsive Design Improvements */
        @media (max-width: 1024px) {
            /* Tablet and mobile adjustments */
            .sidebar-mobile-hidden {
                display: none;
            }
            
            /* Adjust header padding */
            header {
                padding: 0.75rem 1rem !important;
            }
            
            /* Make main content responsive */
            main {
                padding: 1rem !important;
            }
            
            /* Responsive cards */
            .patient-card {
                margin-bottom: 1rem;
            }
            
            /* Mobile-friendly buttons */
            .mobile-btn {
                padding: 0.5rem;
                min-width: 44px;
                min-height: 44px;
            }
            
            /* Adjust search bar */
            .search-container {
                max-width: none !important;
                margin: 0 0.5rem !important;
            }
        }
        
        @media (max-width: 768px) {
            /* Mobile specific adjustments */
            .text-responsive {
                font-size: 0.875rem;
            }
            
            /* Hide less important elements on mobile */
            .mobile-hidden {
                display: none !important;
            }
            
            /* Adjust spacing */
            .space-mobile {
                gap: 0.5rem !important;
            }
            
            /* Full width cards on mobile */
            .mobile-full-width {
                width: 100% !important;
                margin: 0 !important;
            }
            
            /* Adjust notification panel for mobile */
            #notificationPanel {
                right: -16px !important;
                width: calc(100vw - 32px) !important;
                max-width: none !important;
            }
            
            /* Mobile header adjustments */
            header {
                padding: 0.5rem 0.75rem !important;
            }
            
            /* Mobile sidebar full width */
            #sidebar {
                width: 100vw !important;
            }
        }
        
        @media (max-width: 640px) {
            /* Extra small screens */
            .text-xs-responsive {
                font-size: 0.75rem;
            }
            
            /* Very compact spacing */
            .space-xs {
                gap: 0.25rem !important;
            }
            
            /* Hide text on very small screens */
            .xs-hidden {
                display: none !important;
            }
            
            /* Adjust language selector for very small screens */
            #languageSelector {
                padding: 0.5rem !important;
                min-width: 40px !important;
            }
            
            #languageDropdown {
                width: calc(100vw - 2rem) !important;
                right: -1rem !important;
            }
        }
        
        /* RTL Support for Language System */
        [dir="rtl"] {
            text-align: right;
        }
        
        [dir="rtl"] .flex {
            flex-direction: row-reverse;
        }
        
        [dir="rtl"] .space-x-3 > * + * {
            margin-left: 0;
            margin-right: 0.75rem;
        }
        
        [dir="rtl"] .space-x-4 > * + * {
            margin-left: 0;
            margin-right: 1rem;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }
    
        .sidebar.show {
            transform: translateX(0);
            width: 100vw !important;
        }
    
        /* Ensure inner content spans full width */
        .sidebar-inner {
            width: 100vw;
            max-width: none;
            padding: 0;
            margin: 0;
        }
    
        /* Menu styling */
        #sidebar-menu {
            width: 100vw;
            padding: 0;
        }
    
        .sidebar-menu ul {
            width: 100%;
            margin: 0;
            padding: 0;
        }
    
       /* Default menu item styles (not active) */
.sidebar-menu ul li {
    list-style: none;
}

.sidebar-menu ul li a {
    color: white;
    background: rgb(14, 82, 116);
    text-decoration: none;
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-radius: 5px; /* Optional for rounded corners */
    transition: all 0.3s ease; /* Smooth transition */
}

/* Active menu item styles */
.sidebar-menu ul li.active a {
    color: rgb(14, 82, 116); /* Active text color */
    background: white; /* Active background */
    font-weight: bold; /* Optional: Bold text for emphasis */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Optional: Shadow for active item */
}

/* Hover effect */
.sidebar-menu ul li a:hover {
    color: rgb(200, 200, 200); /* Optional: Hover text color */
}

/* Icon Colors */
.sidebar-menu ul li a i {
    margin-right: 10px;
    font-size: 16px;
    transition: color 0.3s ease; /* Smooth transition for icon color */
}

.sidebar-menu ul li a:hover i,
.sidebar-menu ul li.active a i {
    color: #ffffff; /* White icon color on hover and active */
}

        /* Profile section */
        .sidebar-profile {
            width: 100vw;
            box-sizing: border-box;
        }
    
        /* Overlay */
        .sidebar-overlay.show {
            width: 100vw;
            left: 0;
        }
    
        /* Close button */
        .sidebar-close {
            position: fixed;
            right: 15px;
        }
    
        /* Remove any margin from page wrapper */
        .page-wrapper {
            margin-left: 0 !important;
            width: 100vw;
        }
    
        /* Force hardware acceleration for smoother transitions */
        .sidebar {
            -webkit-transform: translateX(-100%);
            transform: translateX(-100%);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
    
        .sidebar.show {
            -webkit-transform: translateX(0);
            transform: translateX(0);
        }
        
        /* Ensure no horizontal scrolling */
        body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        /* Header Styles */
        .header {
            background-color: rgb(14, 82, 116);;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            height: 60px;
            padding: 0 15px;
            display: flex;
            align-items: center;
        }
        
        /* Logo */
        .header-left {
            padding: 0 15px;
        }
        .header .logo img{
            height: 100px;
            width:100px;
            
        }
        /* Search Bar */
        .search-bar {
            flex: 1;
            max-width: 600px;
            margin: 0 20px;
        }
        
        .search-bar form {
            width: 100%;
        }
        
        .search-bar .form-control {
            border-radius: 20px 0 0 20px;
            border-right: none;
        }
        
        .search-bar .btn {
            border-radius: 0 20px 20px 0;
            
        }
        
        /* User Menu */
        .user-menu {
            margin-left: auto;
            display: flex;
            align-items: center;
        }
        
        .user-menu .nav-item {
            margin: 0 5px;
        }
        
        .user-menu .nav-link {
            padding: 0 10px;
            position: relative;
        }
        
        /* Mobile Search */
        .mobile-search {
            display: none;
            padding: 10px 15px;
            background: #fff;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .mobile-search.show {
            display: block;
        }
        
        /* Responsive Styles */
        @media (max-width: 991.98px) {
            .header {
                padding: 0 10px;
            }
        
            .search-bar {
                display: none;
            }
        
            .user-menu .nav-item {
                margin: 0 2px;
            }
        
            .user-menu .nav-link {
                padding: 0 5px;
            }
        
            .header-left {
                padding: 0 5px;
            }
        
            .notifications {
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                width: 100%;
                margin: 0;
            }
        }

        
        @media (max-width: 575.98px) {
            .user-menu .nav-item.d-none {
                display: none !important;
            }
            
            .user-menu .user-link span.user-img {
                margin-right: 0;
            }
        }
        
    .main-wrapper {
        margin-top: 60px;
        min-height: calc(100vh - 60px);
        position: relative;
    }

    /* Sidebar Overlay */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
        z-index: 998;
    }

    /* Sidebar styles */
    
    /* Sidebar inner content */
    .sidebar-inner {
        padding-top: 60px;
        height: 100%;
    }

    .sidebar-profile {
        text-align: center;
        padding: 20px 15px;
        border-bottom: 1px solid #ddd;
    }

    .sidebar-profile img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 2px solid #007bff;
        padding: 5px;
    }

    .sidebar-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

   
    /* Close button */
    .sidebar-close {
        display: none;
        position: absolute;
        top: 70px;
        right: 20px;
        background: none;
        border: none;
        color: #333;
        font-size: 24px;
        cursor: pointer;
        z-index: 1001;
    }

    /* Page wrapper */
    .page-wrapper {
        margin-left: 240px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    /* Header elements */
    .header .nav.user-menu {
        margin-left: auto;
    }

    .header .nav.user-menu a i,
    .header .nav.user-menu a span {
        color: #007bff;
    }

    #toggle_btn,
    #mobile_btn {
        color: #007bff;
        cursor: pointer;
        font-size: 20px;
        padding: 15px;
    }

    /* Mini sidebar styles */
    .mini-sidebar .sidebar {
        width: 80px;
    }

    .mini-sidebar .sidebar-profile img {
        width: 40px;
        height: 40px;
    }

    .mini-sidebar .sidebar-profile h4,
    .mini-sidebar .sidebar-profile p,
    .mini-sidebar .sidebar-menu ul li a span,
    .mini-sidebar .menu-title {
        display: none;
    }

    .mini-sidebar .page-wrapper {
        margin-left: 60px;
    }

    /* Mobile styles */
    

    /* Submenu styles */
    .submenu ul {
        display: none;
        padding-left: 20px !important;
    }

    .submenu.active ul {
        display: block;
    }

    .menu-title {
        padding: 12px 20px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
    }
    
    /* Reduce logo size when mini-sidebar is active */
.mini-sidebar .header .logo img {
    width: 50px;
    height: 50px;
    transition: all 0.3s ease; /* Smooth transition */
}


/* Add this to your existing CSS */

    </style>
    
    
    
</head>
    

<body class="bg-gradient-to-br from-patient-gray to-patient-light-blue min-h-screen font-patient">
    <!-- Modern Patient Dashboard Layout -->
    <div class="flex h-screen overflow-hidden">
        


        <!-- Modern Sidebar -->
        <div id="sidebar" class="w-64 sm:w-72 lg:w-64 bg-gradient-to-b from-patient-blue to-patient-dark-blue shadow-2xl transform transition-transform duration-300 ease-in-out lg:translate-x-0 -translate-x-full fixed lg:relative z-40 h-full flex flex-col">
            <!-- Sidebar Header -->
            <div class="p-4 sm:p-6 border-b border-white/10 flex-shrink-0">
                <div class="flex items-center space-x-3">
                    <img src="{% static 'MedicalSiteLogo.svg' %}" alt="Medical Platform" class="h-8 w-8 sm:h-10 sm:w-10">
                    <div>
                        <h2 class="text-white font-bold text-base sm:text-lg">Patient Portal</h2>
                        <p class="text-white/70 text-xs sm:text-sm">Healthcare Dashboard</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Menu -->
            <nav class="flex-1 mt-4 sm:mt-6 px-3 sm:px-4 space-y-2 custom-scrollbar overflow-y-auto">
                <div class="pb-20">
                <a href="{% url 'patientdashboard:appointments_patients' %}" class="flex items-center space-x-3 px-3 sm:px-4 py-3 text-white/90 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 {% if request.resolver_match.url_name == 'appointments_patients' %}bg-white/20 text-white{% endif %}">
                    <i class="fas fa-tachometer-alt text-base sm:text-lg"></i>
                    <span class="font-medium text-sm sm:text-base" data-translate="Dashboard">Dashboard</span>
                </a>
                
                <a href="{% url 'patient_dashboard:specialty_selection' %}" class="flex items-center space-x-3 px-3 sm:px-4 py-3 text-white/90 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 {% if request.resolver_match.url_name == 'specialty_selection' %}bg-white/20 text-white{% endif %}">
                    <i class="fas fa-calendar-plus text-base sm:text-lg"></i>
                    <span class="font-medium text-sm sm:text-base" data-translate="Book Appointment">Book Appointment</span>
                </a>
                
                <a href="{% url 'patient_dashboard:all_bills' %}" class="flex items-center space-x-3 px-3 sm:px-4 py-3 text-white/90 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 {% if request.resolver_match.url_name == 'all_bills' %}bg-white/20 text-white{% endif %}">
                    <i class="fas fa-file-invoice-dollar text-base sm:text-lg"></i>
                    <span class="font-medium text-sm sm:text-base" data-translate="Bills & Payments">Bills & Payments</span>
                </a>
                
                <a href="{% url 'patientdashboard:exercises' %}" class="flex items-center space-x-3 px-3 sm:px-4 py-3 text-white/90 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 {% if request.resolver_match.url_name == 'exercises' %}bg-white/20 text-white{% endif %}">
                    <i class="fas fa-dumbbell text-base sm:text-lg"></i>
                    <span class="font-medium text-sm sm:text-base" data-translate="Exercises">Exercises</span>
                </a>
                
                <a href="{% url 'patientdashboard:symptoms_list' %}" class="flex items-center space-x-3 px-3 sm:px-4 py-3 text-white/90 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 {% if request.resolver_match.url_name == 'symptoms_list' %}bg-white/20 text-white{% endif %}">
                    <i class="fas fa-stethoscope text-base sm:text-lg"></i>
                    <span class="font-medium text-sm sm:text-base" data-translate="Symptoms">Symptoms</span>
                </a>
                
                <a href="{% url 'patient_dashboard:eligible_practitioners_for_review' %}" class="flex items-center space-x-3 px-3 sm:px-4 py-3 text-white/90 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 {% if request.resolver_match.url_name == 'eligible_practitioners_for_review' %}bg-white/20 text-white{% endif %}">
                    <i class="fas fa-star text-base sm:text-lg"></i>
                    <span class="font-medium text-sm sm:text-base" data-translate="Reviews">Reviews</span>
                </a>
                
                <a href="{% url 'chat:browse_practitioners' %}" class="flex items-center space-x-3 px-3 sm:px-4 py-3 text-white/90 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 {% if request.resolver_match.url_name == 'browse_practitioners' %}bg-white/20 text-white{% endif %}">
                    <i class="fas fa-comments text-base sm:text-lg"></i>
                    <span class="font-medium text-sm sm:text-base" data-translate="Message Doctors">Message Doctors</span>
                </a>
                </div>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Modern Header -->
            <header class="bg-white/80 backdrop-blur-lg shadow-sm border-b border-gray-200/50 px-2 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex items-center justify-between">
                    <!-- Mobile Menu Button -->
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg text-patient-blue hover:bg-patient-light-blue transition-colors mobile-btn">
                        <i class="fas fa-bars text-lg sm:text-xl"></i>
                    </button>
                    
                    <!-- Search Bar -->
                    <div class="flex-1 max-w-2xl mx-1 sm:mx-2 md:mx-4 search-container">
                        <form action="{% url 'patientdashboard:search' %}" method="get" class="relative">
                            <input type="text" 
                                   name="query" 
                                   class="w-full px-3 sm:px-4 py-2 pl-8 sm:pl-10 pr-12 sm:pr-16 bg-white/70 border border-gray-200 rounded-lg sm:rounded-xl focus:outline-none focus:ring-2 focus:ring-patient-blue/50 focus:border-patient-blue transition-all duration-200 text-sm sm:text-base" 
                                   placeholder="Search doctors, specialties..." 
                                   data-translate="Search"
                                   value="{{ query|default:'' }}">
                            <i class="fas fa-search absolute left-2 sm:left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                            <button type="submit" class="absolute right-1 sm:right-2 top-1/2 transform -translate-y-1/2 px-2 sm:px-3 py-1 bg-patient-blue text-white rounded-md sm:rounded-lg hover:bg-patient-dark-blue transition-colors">
                                <i class="fas fa-search text-xs sm:text-sm"></i>
                            </button>
                        </form>
                    </div>
                    
                    <!-- User Profile -->
                    <div class="flex items-center space-x-1 sm:space-x-2 md:space-x-4">
                        <!-- Language Selector -->
                        <div class="relative language-selector-container">
                            <button id="languageSelector" class="flex items-center space-x-2 px-3 py-2 bg-gradient-to-r from-patient-blue to-patient-purple text-white hover:from-patient-dark-blue hover:to-patient-blue rounded-full transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" onclick="toggleLanguageDropdown()">
                                <i class="fas fa-globe text-sm"></i>
                                <span id="currentLanguage" class="text-sm font-medium hidden sm:inline">English</span>
                                <i class="fas fa-chevron-down text-xs transition-transform duration-200" id="languageChevron"></i>
                            </button>
                            
                            <!-- Language Dropdown -->
                            <div id="languageDropdown" class="absolute right-0 top-full mt-3 w-56 bg-white rounded-2xl shadow-2xl border border-gray-100 py-3 z-[99999] hidden backdrop-blur-lg" style="z-index: 99999 !important; position: absolute !important; right: 0 !important; top: calc(100% + 0.75rem) !important;">
                                <div class="px-4 py-2 text-xs font-bold text-patient-blue uppercase tracking-wider border-b border-gray-100 mb-2">
                                    <i class="fas fa-language mr-2"></i>Choose Language
                                </div>
                                
                                <button onclick="changeLanguage('en', 'English')" class="language-option w-full text-left px-4 py-3 hover:bg-gradient-to-r hover:from-patient-light-blue hover:to-blue-50 text-gray-700 hover:text-patient-dark-blue transition-all duration-200 flex items-center space-x-3 group">
                                    <span class="w-8 h-6 bg-gradient-to-r from-blue-600 to-red-600 rounded-md flex items-center justify-center text-white text-xs font-bold shadow-sm group-hover:shadow-md transition-shadow">ðŸ‡ºðŸ‡¸</span>
                                    <div class="flex flex-col">
                                        <span class="font-medium">English</span>
                                        <span class="text-xs text-gray-500">United States</span>
                                    </div>
                                </button>
                                
                                <button onclick="changeLanguage('ur', 'Ø§Ø±Ø¯Ùˆ')" class="language-option w-full text-left px-4 py-3 hover:bg-gradient-to-r hover:from-patient-light-blue hover:to-blue-50 text-gray-700 hover:text-patient-dark-blue transition-all duration-200 flex items-center space-x-3 group">
                                    <span class="w-8 h-6 bg-gradient-to-r from-green-600 to-green-700 rounded-md flex items-center justify-center text-white text-xs font-bold shadow-sm group-hover:shadow-md transition-shadow">ðŸ‡µðŸ‡°</span>
                                    <div class="flex flex-col">
                                        <span class="font-medium">Ø§Ø±Ø¯Ùˆ</span>
                                        <span class="text-xs text-gray-500">Pakistan</span>
                                    </div>
                                </button>
                                
                                <button onclick="changeLanguage('ar', 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©')" class="language-option w-full text-left px-4 py-3 hover:bg-gradient-to-r hover:from-patient-light-blue hover:to-blue-50 text-gray-700 hover:text-patient-dark-blue transition-all duration-200 flex items-center space-x-3 group">
                                    <span class="w-8 h-6 bg-gradient-to-r from-green-700 to-green-800 rounded-md flex items-center justify-center text-white text-xs font-bold shadow-sm group-hover:shadow-md transition-shadow">ðŸ‡¸ðŸ‡¦</span>
                                    <div class="flex flex-col">
                                        <span class="font-medium">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
                                        <span class="text-xs text-gray-500">Saudi Arabia</span>
                                    </div>
                                </button>
                                
                                <button onclick="changeLanguage('hi', 'à¤¹à¤¿à¤‚à¤¦à¥€')" class="language-option w-full text-left px-4 py-3 hover:bg-gradient-to-r hover:from-patient-light-blue hover:to-blue-50 text-gray-700 hover:text-patient-dark-blue transition-all duration-200 flex items-center space-x-3 group">
                                    <span class="w-8 h-6 bg-gradient-to-r from-orange-500 to-orange-600 rounded-md flex items-center justify-center text-white text-xs font-bold shadow-sm group-hover:shadow-md transition-shadow">ðŸ‡®ðŸ‡³</span>
                                    <div class="flex flex-col">
                                        <span class="font-medium">à¤¹à¤¿à¤‚à¤¦à¥€</span>
                                        <span class="text-xs text-gray-500">India</span>
                                    </div>
                                </button>
                                
                                <button onclick="changeLanguage('es', 'EspaÃ±ol')" class="language-option w-full text-left px-4 py-3 hover:bg-gradient-to-r hover:from-patient-light-blue hover:to-blue-50 text-gray-700 hover:text-patient-dark-blue transition-all duration-200 flex items-center space-x-3 group">
                                    <span class="w-8 h-6 bg-gradient-to-r from-red-600 to-yellow-500 rounded-md flex items-center justify-center text-white text-xs font-bold shadow-sm group-hover:shadow-md transition-shadow">ðŸ‡ªðŸ‡¸</span>
                                    <div class="flex flex-col">
                                        <span class="font-medium">EspaÃ±ol</span>
                                        <span class="text-xs text-gray-500">Spain</span>
                                    </div>
                                </button>
                                
                                <button onclick="changeLanguage('fr', 'FranÃ§ais')" class="language-option w-full text-left px-4 py-3 hover:bg-gradient-to-r hover:from-patient-light-blue hover:to-blue-50 text-gray-700 hover:text-patient-dark-blue transition-all duration-200 flex items-center space-x-3 group">
                                    <span class="w-8 h-6 bg-gradient-to-r from-blue-700 to-red-700 rounded-md flex items-center justify-center text-white text-xs font-bold shadow-sm group-hover:shadow-md transition-shadow">ðŸ‡«ðŸ‡·</span>
                                    <div class="flex flex-col">
                                        <span class="font-medium">FranÃ§ais</span>
                                        <span class="text-xs text-gray-500">France</span>
                                    </div>
                                </button>
                                
                                <button onclick="changeLanguage('de', 'Deutsch')" class="language-option w-full text-left px-4 py-3 hover:bg-gradient-to-r hover:from-patient-light-blue hover:to-blue-50 text-gray-700 hover:text-patient-dark-blue transition-all duration-200 flex items-center space-x-3 group">
                                    <span class="w-8 h-6 bg-gradient-to-r from-black to-red-700 rounded-md flex items-center justify-center text-white text-xs font-bold shadow-sm group-hover:shadow-md transition-shadow">ðŸ‡©ðŸ‡ª</span>
                                    <div class="flex flex-col">
                                        <span class="font-medium">Deutsch</span>
                                        <span class="text-xs text-gray-500">Germany</span>
                                    </div>
                                </button>
                                
                                <button onclick="changeLanguage('zh', 'ä¸­æ–‡')" class="language-option w-full text-left px-4 py-3 hover:bg-gradient-to-r hover:from-patient-light-blue hover:to-blue-50 text-gray-700 hover:text-patient-dark-blue transition-all duration-200 flex items-center space-x-3 group">
                                    <span class="w-8 h-6 bg-gradient-to-r from-red-700 to-yellow-600 rounded-md flex items-center justify-center text-white text-xs font-bold shadow-sm group-hover:shadow-md transition-shadow">ðŸ‡¨ðŸ‡³</span>
                                    <div class="flex flex-col">
                                        <span class="font-medium">ä¸­æ–‡</span>
                                        <span class="text-xs text-gray-500">China</span>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Notifications -->
                        <div class="relative mobile-hidden" id="notificationDropdown">
                            <button onclick="toggleNotifications()" class="p-2 text-patient-blue hover:bg-patient-light-blue rounded-lg transition-colors relative mobile-btn">
                                <i class="fas fa-bell text-base sm:text-lg"></i>
                                {% if notifications_count > 0 %}
                                <span id="notificationBadge" class="absolute -top-1 -right-1 bg-patient-red text-white text-xs w-4 h-4 sm:w-5 sm:h-5 rounded-full flex items-center justify-center notification-badge">{{ notifications_count }}</span>
                                {% else %}
                                <span id="notificationBadge" class="absolute -top-1 -right-1 bg-patient-red text-white text-xs w-4 h-4 sm:w-5 sm:h-5 rounded-full flex items-center justify-center notification-badge hidden">0</span>
                                {% endif %}
                            </button>
                            
                            <!-- Notification Dropdown -->
                            <div id="notificationPanel" class="absolute right-0 top-full mt-2 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 hidden transform origin-top-right">
                                <!-- Header -->
                                <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-patient-blue to-patient-dark-blue text-white rounded-t-xl">
                                    <div class="flex items-center justify-between">
                                        <h3 class="font-semibold text-lg">Notifications</h3>
                                        <button onclick="markAllAsRead()" class="text-white/80 hover:text-white text-sm transition-colors">
                                            Mark all read
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Notification List -->
                                <div class="max-h-96 overflow-y-auto custom-scrollbar">
                                    {% if recent_notifications %}
                                        {% for notification in recent_notifications %}
                                        <div class="p-4 border-b border-gray-100 hover:bg-patient-light-blue/30 transition-colors cursor-pointer" onclick="viewNotification('{{ notification.type }}', '{{ notification.id }}')">>
                                            <div class="flex items-start space-x-3">
                                                <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 notification-icon-{{ notification.color }}">
                                                    <i class="fas fa-{{ notification.icon }} notification-text-{{ notification.color }}"></i>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="font-medium text-patient-dark-blue text-sm">{{ notification.title }}</p>
                                                    <p class="text-patient-dark-gray text-xs mt-1">{{ notification.message }}</p>
                                                    {% if notification.subtitle %}
                                                    <p class="text-xs mt-1 notification-text-{{ notification.color }}">{{ notification.subtitle }}</p>
                                                    {% endif %}
                                                </div>
                                                <div class="flex flex-col items-end">
                                                    {% if not notification.is_read %}
                                                    <span class="w-2 h-2 rounded-full notification-bg-{{ notification.color }}"></span>
                                                    {% endif %}
                                                    <span class="text-xs text-patient-dark-gray mt-1">{{ notification.time_ago }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <!-- No Notifications -->
                                        <div class="p-8 text-center">
                                            <div class="w-16 h-16 bg-patient-light-blue rounded-full flex items-center justify-center mx-auto mb-4">
                                                <i class="fas fa-bell-slash text-patient-blue text-2xl"></i>
                                            </div>
                                            <h3 class="font-medium text-patient-dark-blue mb-2">No notifications</h3>
                                            <p class="text-patient-dark-gray text-sm">You're all caught up!</p>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Footer -->
                                <div class="p-4 border-t border-gray-200 bg-patient-gray rounded-b-xl">
                                    <button onclick="viewAllNotifications()" class="w-full text-center text-patient-blue hover:text-patient-dark-blue font-medium text-sm transition-colors">
                                        View All Notifications
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2 sm:space-x-3">
                            <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-patient-blue to-patient-purple rounded-full flex items-center justify-center">
                                {% if patient and patient.profile_photo %}
                                    <img src="{{ patient.profile_photo.url }}" alt="Profile" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover">
                                {% else %}
                                    <i class="fas fa-user text-white text-sm sm:text-base"></i>
                                {% endif %}
                            </div>
                            <div class="hidden lg:block">
                                <p class="text-sm font-medium text-patient-dark-blue">Welcome back!</p>
                                <p class="text-xs text-patient-dark-gray">Patient Dashboard</p>
                            </div>
                        </div>
                        
                        <a href="{% url 'frontend:logout' %}" class="px-2 sm:px-4 py-2 bg-patient-red text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium mobile-btn" data-translate="Logout">
                            <i class="fas fa-sign-out-alt sm:mr-2"></i><span class="hidden sm:inline">Logout</span>
                        </a>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main class="flex-1 overflow-y-auto p-2 sm:p-4 lg:p-6 custom-scrollbar">
                {% block content %}
                <!-- Page content will be inserted here -->
                {% endblock content %}
            </main>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden" onclick="toggleSidebar()"></div>

<script>
    let chatSocket;
    let selectedVoice = null;
    function initializeVoice() {
    // Common male voice names across different browsers/OS
    const maleVoiceNames = [
        "Google US English Male",
        "Microsoft David Desktop",
        "Alex", // macOS
        "Daniel", // macOS
        "Fred", // macOS
        "Microsoft Mark", // Edge
        "Microsoft Eric", // Edge
        "English (America) - Male"
    ];

    // Wait for voices to be loaded
    speechSynthesis.onvoiceschanged = function() {
        const voices = speechSynthesis.getVoices();
        
        // Try to find a male voice
        selectedVoice = voices.find(voice => 
            maleVoiceNames.some(name => voice.name.includes(name)) ||
            // Fallback: look for voices that sound male
            voices.find(voice => 
                voice.lang.includes('en') && 
                (voice.name.toLowerCase().includes('male') || 
                 voice.name.toLowerCase().includes('david') ||
                 voice.name.toLowerCase().includes('mark'))
        ));
        
        // Fallback to first available English voice
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => voice.lang.includes('en')) || 
                           voices[0];
        }
    };
    
    // Trigger voiceschanged event if voices are already loaded
    if (speechSynthesis.getVoices().length > 0) {
        speechSynthesis.onvoiceschanged();
    }
}


function toggleChatbot() {
    let chatbotWindow = document.getElementById("chatbot-window");
    let avatarContainer = document.getElementById("ai-avatar-container");
    
    console.log("toggleChatbot called");
    console.log("chatbotWindow:", chatbotWindow);
    console.log("Current display:", chatbotWindow ? chatbotWindow.style.display : "element not found");
    
    if (!chatbotWindow) {
        console.error("Chatbot window not found!");
        return;
    }
    
    if (chatbotWindow.style.display === "none" || chatbotWindow.style.display === "") {
        console.log("Opening chatbot");
        chatbotWindow.style.display = "flex";
        chatbotWindow.style.zIndex = "1001";
        
        // Avatar gets attention when chat opens
        if (avatarContainer) {
            avatarContainer.classList.add("attention");
            setTimeout(() => {
                avatarContainer.classList.remove("attention");
            }, 2000);
        }
    } else {
        console.log("Closing chatbot");
        chatbotWindow.style.display = "none";
        
        // Stop any ongoing speech and animations
        speechSynthesis.cancel();
        if (avatarContainer) {
            avatarContainer.classList.remove("talking");
            avatarContainer.classList.remove("attention");
        }
    }
}

function connectWebSocket() {
    chatSocket = new WebSocket("ws://" + window.location.host + "/ws/ai-chat/");

    chatSocket.onopen = function () {
        console.log("AI Chatbot WebSocket connected.");
    };

    chatSocket.onmessage = function(event) {
        let data = JSON.parse(event.data);
        let botMessage = data.message;
        
        displayMessage(botMessage, "bot");
        
        // Generate D-ID talking avatar video
        avatarGetAttention();
        setTimeout(() => {
            didAvatarManager.generateAndPlayVideo(botMessage);
        }, 500);
    };

    chatSocket.onerror = function (error) {
        console.error("WebSocket Error:", error);
    };

    chatSocket.onclose = function(event) {
        console.log("WebSocket closed. Reconnecting in 3 seconds...");
        setTimeout(connectWebSocket, 3000);
    };
}

function sendMessage() {
    let userInput = document.getElementById("chat-input").value;
    if (userInput.trim() === "") return;

    displayMessage(userInput, "user");

    chatSocket.send(JSON.stringify({ 
        "message": userInput,
        "patient_id": "{{ request.session.patient_id|default:'' }}"  
    }));

    document.getElementById("chat-input").value = "";
}

function handleKeyPress(event) {
    if (event.key === "Enter") {
        sendMessage();
    }
}

function displayMessage(message, sender) {
    let chatMessages = document.getElementById("chat-messages");
    let messageDiv = document.createElement("div");
    messageDiv.classList.add(sender === "bot" ? "bot-message" : "user-message");
    messageDiv.textContent = message;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;  
}
// D-ID Avatar Video Management
class DIDAvatarManager {
    constructor() {
        this.avatarVideo = document.getElementById("avatar-video");
        this.avatarImg = document.getElementById("ai-avatar-img");
        this.avatarLoading = document.getElementById("avatar-loading");
        this.speechDisplay = document.getElementById("avatar-speech-display");
        this.speechContent = document.getElementById("speech-content");
        this.isGenerating = false;
        this.currentVideoUrl = null;
    }
    
    showLoading() {
        this.avatarLoading.style.display = "block";
        this.avatarImg.style.opacity = "0.3";
    }
    
    hideLoading() {
        this.avatarLoading.style.display = "none";
        this.avatarImg.style.opacity = "1";
    }
    
    showSpeechText(text) {
        this.speechContent.textContent = text;
        this.speechDisplay.classList.add("active");
        this.speechDisplay.classList.add("speaking");
    }
    
    hideSpeechText() {
        this.speechDisplay.classList.remove("speaking");
        setTimeout(() => {
            this.speechDisplay.classList.remove("active");
            this.speechContent.textContent = "Hi! I'm your AI medical assistant. Click me to start chatting!";
        }, 3000);
    }
    
    async generateAndPlayVideo(text) {
        if (this.isGenerating) {
            console.log("Already generating video, please wait...");
            return;
        }
        
        this.isGenerating = true;
        this.showLoading();
        this.showSpeechText(text);
        
        try {
            console.log("Generating D-ID avatar video for:", text);
            
            // Call backend to generate D-ID video
            const response = await fetch('/generate-avatar-response/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ message: text })
            });
            
            const data = await response.json();
            
            if (data.success && data.avatar_video) {
                // Play the generated transparent video
                await this.playAvatarVideo(data.avatar_video);
                console.log("D-ID video played successfully");
            } else {
                // Fallback to text-to-speech
                console.log("Video generation failed, using TTS fallback");
                this.fallbackToTTS(data.response_text || text);
            }
            
        } catch (error) {
            console.error("Avatar generation error:", error);
            this.fallbackToTTS(text);
        } finally {
            this.isGenerating = false;
            this.hideLoading();
        }
    }
    
    async playAvatarVideo(videoUrl) {
        return new Promise((resolve, reject) => {
            // Hide static image
            this.avatarImg.style.display = "none";
            
            // Set video source
            this.avatarVideo.src = videoUrl;
            this.avatarVideo.style.display = "block";
            
            // Play video
            this.avatarVideo.onloadeddata = () => {
                this.avatarVideo.play().then(() => {
                    console.log("Avatar video started playing");
                    resolve();
                }).catch(reject);
            };
            
            // When video ends, return to static image
            this.avatarVideo.onended = () => {
                this.avatarVideo.style.display = "none";
                this.avatarImg.style.display = "block";
                this.hideSpeechText();
                console.log("Avatar video ended");
            };
            
            this.avatarVideo.onerror = (error) => {
                console.error("Video playback error:", error);
                this.avatarVideo.style.display = "none";
                this.avatarImg.style.display = "block";
                reject(error);
            };
        });
    }
    
    fallbackToTTS(text) {
        // Fallback to original text-to-speech
        if (!selectedVoice) {
            initializeVoice();
        }

        let speech = new SpeechSynthesisUtterance(text);
        speech.lang = "en-US";
        speech.pitch = 0.9;
        speech.rate = 0.9;
        
        if (selectedVoice) {
            speech.voice = selectedVoice;
        }
        
        speech.onend = () => {
            this.hideSpeechText();
        };
        
        speechSynthesis.cancel();
        speechSynthesis.speak(speech);
    }
    
    loadIdleVideo() {
        // Load idle/breathing video when not talking
        fetch('/get-idle-avatar/')
            .then(response => response.json())
            .then(data => {
                if (data.idle_video) {
                    this.avatarVideo.src = data.idle_video;
                    this.avatarVideo.style.display = "block";
                    this.avatarImg.style.display = "none";
                    this.avatarVideo.play();
                }
            })
            .catch(error => {
                console.log("No idle video available:", error);
            });
    }
}

// Initialize D-ID Avatar Manager
const didAvatarManager = new DIDAvatarManager();

// Updated function to use D-ID video generation
function speakAIResponse(text) {
    didAvatarManager.generateAndPlayVideo(text);
}

// Add function to make avatar get attention when new message arrives
function avatarGetAttention() {
    let avatarContainer = document.getElementById("ai-avatar-container");
    avatarContainer.classList.add("attention");
    
    // Remove attention effect after 3 seconds
    setTimeout(() => {
        avatarContainer.classList.remove("attention");
    }, 3000);
}
// Add periodic idle animations to make avatar feel more alive
function addIdleAnimations() {
    const avatarContainer = document.getElementById("ai-avatar-container");
    
    setInterval(() => {
        if (!speechSynthesis.speaking && !avatarContainer.classList.contains("talking")) {
            // Random subtle movements every 10 seconds
            const randomAnimation = Math.random();
            if (randomAnimation < 0.4) {
                avatarContainer.style.transform = "scale(1.02) translateY(-2px)";
                setTimeout(() => {
                    avatarContainer.style.transform = "";
                }, 1200);
            }
        }
    }, 10000);
}

// Add greeting when avatar is first clicked
function avatarGreeting() {
    const avatarContainer = document.getElementById("ai-avatar-container");
    avatarContainer.classList.add("attention");
    
    const greetingText = "Hello! I'm your AI medical assistant. How can I help you today?";
    
    // Generate D-ID greeting video
    setTimeout(() => {
        didAvatarManager.generateAndPlayVideo(greetingText);
        avatarContainer.classList.remove("attention");
    }, 1000);
}

document.addEventListener("DOMContentLoaded", function() {
    initializeVoice();
    addIdleAnimations();
    
    // Initialize chatbot window
    const chatbotWindow = document.getElementById("chatbot-window");
    if (chatbotWindow) {
        chatbotWindow.style.display = "none";
        console.log("Chatbot window initialized");
    } else {
        console.error("Chatbot window not found during initialization!");
    }
    
    // Add avatar click event
    const avatarContainer = document.getElementById("ai-avatar-container");
    if (avatarContainer) {
        console.log("Avatar container found, adding click event");
        avatarContainer.addEventListener("click", function() {
            console.log("Avatar clicked - opening chatbot");
            toggleChatbot();
        });
    } else {
        console.error("Avatar container not found!");
    }
    
    // Add one-time greeting on first interaction
    let hasGreeted = false;
    if (avatarContainer) {
        avatarContainer.addEventListener("click", function() {
            if (!hasGreeted) {
                setTimeout(() => {
                    avatarGreeting();
                }, 500);
                hasGreeted = true;
            }
        });
    }
    
    console.log("AI Avatar initialized - Standing avatar with face animation ready!");
});

connectWebSocket();

</script>


    <!-- Essential Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// Dashboard Language System
const dashboardTranslations = {
    'en': {
        'Dashboard': 'Dashboard',
        'Profile': 'Profile',
        'Book Appointment': 'Book Appointment',
        'Bills & Payments': 'Bills & Payments',
        'Exercises': 'Exercises',
        'Symptoms': 'Symptoms',
        'Reviews': 'Reviews',
        'Search': 'Search doctors, specialties...',
        'Logout': 'Logout',
        'Patient Profile': 'Patient Profile'
    },
    'ur': {
        'Dashboard': 'ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ',
        'Profile': 'Ù¾Ø±ÙˆÙØ§Ø¦Ù„',
        'Book Appointment': 'Ø§Ù¾Ø§Ø¦Ù†Ù¹Ù…Ù†Ù¹ Ø¨Ú© Ú©Ø±ÛŒÚº',
        'Bills & Payments': 'Ø¨Ù„ Ø§ÙˆØ± Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒØ§Úº',
        'Exercises': 'ÙˆØ±Ø²Ø´ÛŒÚº',
        'Symptoms': 'Ø¹Ù„Ø§Ù…Ø§Øª',
        'Reviews': 'Ø¬Ø§Ø¦Ø²Û’',
        'Search': 'ÚˆØ§Ú©Ù¹Ø±Ø²ØŒ Ø®ØµÙˆØµÛŒØ§Øª ØªÙ„Ø§Ø´ Ú©Ø±ÛŒÚº...',
        'Logout': 'Ù„Ø§Ú¯ Ø¢Ø¤Ù¹',
        'Patient Profile': 'Ù…Ø±ÛŒØ¶ Ú©Ø§ Ù¾Ø±ÙˆÙØ§Ø¦Ù„'
    },
    'ar': {
        'Dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
        'Profile': 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
        'Book Appointment': 'Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯',
        'Bills & Payments': 'Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª',
        'Exercises': 'Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†',
        'Symptoms': 'Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶',
        'Reviews': 'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª',
        'Search': 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ ÙˆØ§Ù„ØªØ®ØµØµØ§Øª...',
        'Logout': 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
        'Patient Profile': 'Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶'
    },
    'hi': {
        'Dashboard': 'à¤¡à¥ˆà¤¶à¤¬à¥‹à¤°à¥à¤¡',
        'Profile': 'à¤ªà¥à¤°à¥‹à¤«à¤¾à¤‡à¤²',
        'Book Appointment': 'à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ à¤¬à¥à¤• à¤•à¤°à¥‡à¤‚',
        'Bills & Payments': 'à¤¬à¤¿à¤² à¤”à¤° à¤­à¥à¤—à¤¤à¤¾à¤¨',
        'Exercises': 'à¤µà¥à¤¯à¤¾à¤¯à¤¾à¤®',
        'Symptoms': 'à¤²à¤•à¥à¤·à¤£',
        'Reviews': 'à¤¸à¤®à¥€à¤•à¥à¤·à¤¾à¤à¤‚',
        'Search': 'à¤¡à¥‰à¤•à¥à¤Ÿà¤°, à¤µà¤¿à¤¶à¥‡à¤·à¤¤à¤¾à¤à¤‚ à¤–à¥‹à¤œà¥‡à¤‚...',
        'Logout': 'à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ',
        'Patient Profile': 'à¤®à¤°à¥€à¤œà¤¼ à¤•à¥€ à¤ªà¥à¤°à¥‹à¤«à¤¾à¤‡à¤²'
    },
    'es': {
        'Dashboard': 'Panel de Control',
        'Profile': 'Perfil',
        'Book Appointment': 'Reservar Cita',
        'Bills & Payments': 'Facturas y Pagos',
        'Exercises': 'Ejercicios',
        'Symptoms': 'SÃ­ntomas',
        'Reviews': 'ReseÃ±as',
        'Search': 'Buscar mÃ©dicos, especialidades...',
        'Logout': 'Cerrar SesiÃ³n',
        'Patient Profile': 'Perfil del Paciente'
    },
    'fr': {
        'Dashboard': 'Tableau de Bord',
        'Profile': 'Profil',
        'Book Appointment': 'Prendre Rendez-vous',
        'Bills & Payments': 'Factures et Paiements',
        'Exercises': 'Exercices',
        'Symptoms': 'SymptÃ´mes',
        'Reviews': 'Avis',
        'Search': 'Rechercher mÃ©decins, spÃ©cialitÃ©s...',
        'Logout': 'DÃ©connexion',
        'Patient Profile': 'Profil du Patient'
    },
    'de': {
        'Dashboard': 'Dashboard',
        'Profile': 'Profil',
        'Book Appointment': 'Termin Buchen',
        'Bills & Payments': 'Rechnungen und Zahlungen',
        'Exercises': 'Ãœbungen',
        'Symptoms': 'Symptome',
        'Reviews': 'Bewertungen',
        'Search': 'Ã„rzte, Fachgebiete suchen...',
        'Logout': 'Abmelden',
        'Patient Profile': 'Patientenprofil'
    },
    'zh': {
        'Dashboard': 'ä»ªè¡¨æ¿',
        'Profile': 'ä¸ªäººèµ„æ–™',
        'Book Appointment': 'é¢„çº¦',
        'Bills & Payments': 'è´¦å•å’Œä»˜æ¬¾',
        'Exercises': 'é”»ç‚¼',
        'Symptoms': 'ç—‡çŠ¶',
        'Reviews': 'è¯„è®º',
        'Search': 'æœç´¢åŒ»ç”Ÿã€ä¸“ç§‘...',
        'Logout': 'ç™»å‡º',
        'Patient Profile': 'æ‚£è€…æ¡£æ¡ˆ'
    }
};

const dashboardLanguageNames = {
    'en': 'English',
    'ur': 'Ø§Ø±Ø¯Ùˆ',
    'ar': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
    'hi': 'à¤¹à¤¿à¤¨à¥à¤¦à¥€',
    'es': 'EspaÃ±ol',
    'fr': 'FranÃ§ais',
    'de': 'Deutsch',
    'zh': 'ä¸­æ–‡'
};

// Dashboard Language Change Function (unified with main language system)
window.changeDashboardLanguage = function(langCode) {
    const langName = dashboardLanguageNames[langCode] || 'English';
    changeLanguage(langCode, langName);
};

// Translate Dashboard Content
function translateDashboard(langCode) {
    try {
        const translation = dashboardTranslations[langCode] || dashboardTranslations['en'];
        
        if (!translation) {
            console.error('No translation found for language:', langCode);
            return;
        }
        
        let translatedCount = 0;
        
        // Translate all elements with data-translate attribute
        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.getAttribute('data-translate');
            if (translation[key]) {
                if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'search')) {
                    element.placeholder = translation[key];
                } else {
                    element.textContent = translation[key];
                }
                translatedCount++;
            }
        });
        
        console.log(`Dashboard translation completed: ${translatedCount} elements translated to ${langCode}`);
    } catch (error) {
        console.error('Error in translateDashboard:', error);
    }
}



// Language Dropdown Functionality
function toggleLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    const chevron = document.getElementById('languageChevron');
    const button = document.getElementById('languageSelector');
    
    if (!dropdown || !chevron || !button) {
        console.error('Language dropdown elements not found');
        return;
    }
    
    const isHidden = dropdown.classList.contains('hidden');
    
    if (isHidden) {
        // Show dropdown
        dropdown.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
        
        // Position dropdown properly for mobile
        if (window.innerWidth <= 768) {
            const rect = button.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            
            // Ensure dropdown doesn't go off-screen
            if (rect.right < 256) { // 16rem = 256px
                dropdown.style.right = 'auto';
                dropdown.style.left = '0';
            } else {
                dropdown.style.right = '0';
                dropdown.style.left = 'auto';
            }
        }
    } else {
        // Hide dropdown
        dropdown.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const languageSelector = document.getElementById('languageSelector');
    const languageDropdown = document.getElementById('languageDropdown');
    const chevron = document.getElementById('languageChevron');
    
    if (languageSelector && languageDropdown && !languageSelector.contains(event.target)) {
        languageDropdown.classList.add('hidden');
        if (chevron) {
            chevron.style.transform = 'rotate(0deg)';
        }
    }
});

// Enhanced Language Change Function with RTL Support
function changeLanguage(langCode, langName) {
    try {
        console.log('Changing language to:', langCode, langName);
        
        // Update current language display
        const currentLangElement = document.getElementById('currentLanguage');
        if (currentLangElement) {
            currentLangElement.textContent = langName;
        }
        
        // Store language preference
        localStorage.setItem('patientLanguage', langCode);
        localStorage.setItem('patientLanguageName', langName);
        localStorage.setItem('selectedLanguage', langCode);
        
        // Apply RTL for Arabic and Urdu
        const rtlLanguages = ['ar', 'ur'];
        const htmlElement = document.documentElement;
        
        if (rtlLanguages.includes(langCode)) {
            htmlElement.setAttribute('dir', 'rtl');
            htmlElement.setAttribute('lang', langCode);
            document.body.classList.add('rtl-layout');
        } else {
            htmlElement.setAttribute('dir', 'ltr');
            htmlElement.setAttribute('lang', langCode);
            document.body.classList.remove('rtl-layout');
        }
        
        // Translate all elements with data-translate attribute
        translateDashboard(langCode);
        
        // Close dropdown
        const dropdown = document.getElementById('languageDropdown');
        const chevron = document.getElementById('languageChevron');
        if (dropdown) {
            dropdown.classList.add('hidden');
        }
        if (chevron) {
            chevron.style.transform = 'rotate(0deg)';
        }
        
        // Show success message
        showLanguageChangeNotification(langName);
        
        console.log('Language changed successfully to:', langCode);
    } catch (error) {
        console.error('Error changing language:', error);
    }
}

// Show language change notification
function showLanguageChangeNotification(langName) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-patient-green text-white px-6 py-3 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300';
    notification.style.zIndex = '99999';
    notification.innerHTML = `
        <div class="flex items-center space-x-3">
            <i class="fas fa-check-circle text-lg"></i>
            <span class="font-medium">Language changed to ${langName}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Animate out and remove
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Load saved language on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedLang = localStorage.getItem('patientLanguage') || localStorage.getItem('selectedLanguage') || 'en';
    const savedLangName = localStorage.getItem('patientLanguageName') || dashboardLanguageNames[savedLang] || 'English';
    
    console.log('Loading saved language:', savedLang, savedLangName);
    
    // Update display without showing notification
    const currentLangElement = document.getElementById('currentLanguage');
    if (currentLangElement) {
        currentLangElement.textContent = savedLangName;
    }
    
    // Apply language if not English
    if (savedLang !== 'en') {
        translateDashboard(savedLang);
        
        // Apply RTL if needed
        const rtlLanguages = ['ar', 'ur'];
        if (rtlLanguages.includes(savedLang)) {
            document.documentElement.setAttribute('dir', 'rtl');
            document.documentElement.setAttribute('lang', savedLang);
            document.body.classList.add('rtl-layout');
        }
    }
});

// Mobile Sidebar Toggle Function
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (sidebar.classList.contains('-translate-x-full')) {
        // Show sidebar
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('translate-x-0');
        overlay.classList.remove('hidden');
    } else {
        // Hide sidebar
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('translate-x-0');
        overlay.classList.add('hidden');
    }
}

// Close sidebar when clicking outside on mobile
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.querySelector('[onclick="toggleSidebar()"]');
    const overlay = document.getElementById('sidebar-overlay');
    
    // Check if click is outside sidebar and not on menu button
    if (window.innerWidth < 1024 && 
        !sidebar.contains(event.target) && 
        !mobileMenuBtn.contains(event.target) &&
        !sidebar.classList.contains('-translate-x-full')) {
        
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('translate-x-0');
        overlay.classList.add('hidden');
    }
});

// Handle window resize
window.addEventListener('resize', function() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (window.innerWidth >= 1024) {
        // Desktop view - ensure sidebar is visible and overlay is hidden
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('translate-x-0');
        overlay.classList.add('hidden');
    } else {
        // Mobile view - ensure sidebar is hidden by default
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('translate-x-0');
        overlay.classList.add('hidden');
    }
});

// Auto-hide mobile sidebar when clicking on navigation links
document.addEventListener('DOMContentLoaded', function() {
    const sidebarLinks = document.querySelectorAll('#sidebar a');
    sidebarLinks.forEach(link => {
        link.addEventListener('click', function() {
            if (window.innerWidth < 1024) {
                setTimeout(() => {
                    toggleSidebar();
                }, 100);
            }
        });
    });
});



// Smooth animations for cards
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.patient-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-fade-in');
    });
});

// Auto-hide mobile sidebar when clicking on links
document.querySelectorAll('#sidebar a').forEach(link => {
    link.addEventListener('click', function() {
        if (window.innerWidth < 1024) {
            toggleSidebar();
        }
    });
});

console.log('ðŸ¥ Modern Patient Dashboard Loaded Successfully!');

// Notification System Functions
let notificationCount = parseInt('{{ notifications_count|default:0 }}') || 0;
let isNotificationOpen = false;

function toggleNotifications() {
    const panel = document.getElementById('notificationPanel');
    const overlay = document.getElementById('notificationOverlay') || createNotificationOverlay();
    
    isNotificationOpen = !isNotificationOpen;
    
    if (isNotificationOpen) {
        panel.classList.remove('hidden');
        panel.classList.add('animate-fade-in');
        overlay.classList.add('active');
        overlay.style.display = 'block';
    } else {
        panel.classList.add('hidden');
        panel.classList.remove('animate-fade-in');
        overlay.classList.remove('active');
        overlay.style.display = 'none';
    }
}

function createNotificationOverlay() {
    const overlay = document.createElement('div');
    overlay.id = 'notificationOverlay';
    overlay.className = 'notification-overlay';
    overlay.style.display = 'none';
    
    // Close notification when clicking overlay
    overlay.addEventListener('click', function() {
        if (isNotificationOpen) {
            toggleNotifications();
        }
    });
    
    document.body.appendChild(overlay);
    return overlay;
}

function markAllAsRead() {
    // Send AJAX request to mark all notifications as read
    fetch('/patient-dashboard/mark-notifications-read/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update notification count
            notificationCount = 0;
            updateNotificationBadge();
            
            // Remove red dots from all notifications
            const redDots = document.querySelectorAll('#notificationPanel .bg-patient-red, #notificationPanel .bg-patient-green, #notificationPanel .bg-patient-purple, #notificationPanel .bg-patient-orange, #notificationPanel .bg-patient-teal');
            redDots.forEach(dot => {
                dot.classList.remove('bg-patient-red', 'bg-patient-green', 'bg-patient-purple', 'bg-patient-orange', 'bg-patient-teal');
                dot.classList.add('bg-gray-300');
            });
            
            showNotificationMessage('All notifications marked as read');
        }
    })
    .catch(error => {
        console.error('Error marking notifications as read:', error);
        showNotificationMessage('Error updating notifications');
    });
}

function updateNotificationBadge() {
    const badge = document.getElementById('notificationBadge');
    if (notificationCount > 0) {
        badge.textContent = notificationCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

function viewNotification(type, id) {
    // Close notification panel
    toggleNotifications();
    
    // Navigate based on notification type
    switch(type) {
        case 'appointment':
            window.location.href = '/patient-dashboard/appointments_patients/';
            break;
        case 'results':
            showNotificationMessage('Opening lab results...');
            // Add your lab results URL here
            break;
        case 'prescription':
            window.location.href = '/patient-dashboard/appointments_patients/';
            break;
        case 'message':
            window.location.href = '/patient-dashboard/chat/';
            break;
        default:
            showNotificationMessage('Opening notification...');
    }
    
    // Mark notification as read
    markNotificationAsRead(id);
}

function markNotificationAsRead(notificationId) {
    fetch('/patient-dashboard/mark-notification-read/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            'notification_id': notificationId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && notificationCount > 0) {
            notificationCount--;
            updateNotificationBadge();
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
    });
}

function viewAllNotifications() {
    toggleNotifications();
    window.location.href = '/patient-dashboard/notifications/';
}

function showNotificationMessage(message) {
    // Create notification toast
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-patient-blue text-white px-6 py-3 rounded-lg shadow-lg animate-fade-in';
    toast.style.zIndex = '10007';
    toast.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close notification panel when clicking outside
document.addEventListener('click', function(event) {
    const notificationDropdown = document.getElementById('notificationDropdown');
    const notificationPanel = document.getElementById('notificationPanel');
    
    // Don't close if clicking inside the dropdown or panel
    if (notificationDropdown && notificationDropdown.contains(event.target)) {
        return;
    }
    
    if (notificationPanel && notificationPanel.contains(event.target)) {
        return;
    }
    
    // Close if notification is open and clicked outside
    if (isNotificationOpen) {
        toggleNotifications();
    }
});

// Initialize notification system
document.addEventListener('DOMContentLoaded', function() {
    updateNotificationBadge();
});
</script>

</body>

</html>