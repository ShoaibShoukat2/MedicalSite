{% extends 'patientdashboard/patient_base.html' %}
{% load static %}

{% block title %}Add Symptom - Patient Dashboard{% endblock %}

{% block content %}
<!-- Modern Add Symptom Header -->
<div class="bg-gradient-to-r from-patient-orange to-orange-600 rounded-2xl p-6 mb-8 text-white">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold mb-2" data-translate="Add Symptom">Add New Symptom</h1>
            <p class="text-white/90">Record your symptoms to help your healthcare provider</p>
        </div>
        <div class="mt-4 md:mt-0">
            <a href="{% url 'patientdashboard:symptoms_list' %}" class="inline-flex items-center px-6 py-3 bg-white text-patient-orange rounded-xl hover:bg-orange-50 transition-all duration-300 font-semibold shadow-lg">
                <i class="fas fa-list mr-2"></i>
                <span data-translate="View All Symptoms">View All Symptoms</span>
            </a>
        </div>
    </div>
</div>

<!-- Add Symptom Form -->
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
        <!-- Form Header -->
        <div class="bg-gradient-to-r from-patient-light-blue to-white p-6 border-b border-gray-200">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-patient-orange/10 rounded-xl flex items-center justify-center">
                    <i class="fas fa-notes-medical text-patient-orange text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-patient-dark-blue">Symptom Information</h2>
                    <p class="text-patient-dark-gray">Please provide detailed information about your symptoms</p>
                </div>
            </div>
        </div>

        <!-- Form Content -->
        <form method="POST" class="p-6 md:p-8">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Appointment Selection -->
                    <div>
                        <label for="appointment_id" class="block text-sm font-semibold text-patient-dark-blue mb-3">
                            <i class="fas fa-calendar-alt mr-2 text-patient-blue"></i>
                            Related Appointment
                        </label>
                        <select name="appointment_id" 
                                id="appointment_id"
                                class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-patient-orange/50 focus:border-patient-orange transition-all duration-300 bg-white"
                                required>
                            <option value="">Select an appointment</option>
                            {% for app in appointments %}
                                <option value="{{ app.id }}">
                                    Dr. {{ app.practitioner.first_name }} {{ app.practitioner.last_name }} - {{ app.slot.date|date:"M d, Y" }} at {{ app.slot.start_time|time:"h:i A" }}
                                </option>
                            {% empty %}
                                <option value="">No appointments available</option>
                            {% endfor %}
                        </select>
                        <p class="text-sm text-patient-dark-gray mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Choose the appointment related to these symptoms
                        </p>
                    </div>

                    <!-- Symptom Severity -->
                    <div>
                        <label class="block text-sm font-semibold text-patient-dark-blue mb-3">
                            <i class="fas fa-thermometer-half mr-2 text-patient-red"></i>
                            Symptom Severity
                        </label>
                        <div class="grid grid-cols-3 gap-3">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="severity" value="Low" class="sr-only peer" required>
                                <div class="w-full p-4 bg-white border-2 border-gray-200 rounded-xl peer-checked:border-green-500 peer-checked:bg-green-50 transition-all duration-300 text-center hover:border-green-300">
                                    <i class="fas fa-smile text-green-500 text-2xl mb-2"></i>
                                    <div class="font-semibold text-green-600">Low</div>
                                    <div class="text-xs text-gray-500">Mild discomfort</div>
                                </div>
                            </label>
                            
                            <label class="relative cursor-pointer">
                                <input type="radio" name="severity" value="Medium" class="sr-only peer">
                                <div class="w-full p-4 bg-white border-2 border-gray-200 rounded-xl peer-checked:border-yellow-500 peer-checked:bg-yellow-50 transition-all duration-300 text-center hover:border-yellow-300">
                                    <i class="fas fa-meh text-yellow-500 text-2xl mb-2"></i>
                                    <div class="font-semibold text-yellow-600">Medium</div>
                                    <div class="text-xs text-gray-500">Moderate pain</div>
                                </div>
                            </label>
                            
                            <label class="relative cursor-pointer">
                                <input type="radio" name="severity" value="High" class="sr-only peer">
                                <div class="w-full p-4 bg-white border-2 border-gray-200 rounded-xl peer-checked:border-red-500 peer-checked:bg-red-50 transition-all duration-300 text-center hover:border-red-300">
                                    <i class="fas fa-frown text-red-500 text-2xl mb-2"></i>
                                    <div class="font-semibold text-red-600">High</div>
                                    <div class="text-xs text-gray-500">Severe pain</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Duration -->
                    <div>
                        <label for="duration" class="block text-sm font-semibold text-patient-dark-blue mb-3">
                            <i class="fas fa-clock mr-2 text-patient-purple"></i>
                            Duration
                        </label>
                        <select name="duration" 
                                id="duration"
                                class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-patient-orange/50 focus:border-patient-orange transition-all duration-300 bg-white">
                            <option value="">Select duration</option>
                            <option value="Less than 1 hour">Less than 1 hour</option>
                            <option value="1-6 hours">1-6 hours</option>
                            <option value="6-24 hours">6-24 hours</option>
                            <option value="1-3 days">1-3 days</option>
                            <option value="More than 3 days">More than 3 days</option>
                            <option value="Ongoing">Ongoing</option>
                        </select>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Symptom Details -->
                    <div>
                        <label for="details" class="block text-sm font-semibold text-patient-dark-blue mb-3">
                            <i class="fas fa-file-medical-alt mr-2 text-patient-green"></i>
                            Symptom Details
                        </label>
                        <textarea name="details" 
                                  id="details"
                                  rows="8"
                                  class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-patient-orange/50 focus:border-patient-orange transition-all duration-300 resize-none"
                                  placeholder="Please describe your symptoms in detail. Include:&#10;• What you're experiencing&#10;• When it started&#10;• What makes it better or worse&#10;• Any other relevant information"
                                  required></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-sm text-patient-dark-gray">
                                <i class="fas fa-info-circle mr-1"></i>
                                Be as detailed as possible to help your doctor
                            </p>
                            <span id="char-count" class="text-sm text-patient-dark-gray">0 characters</span>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div>
                        <label for="additional_info" class="block text-sm font-semibold text-patient-dark-blue mb-3">
                            <i class="fas fa-plus-circle mr-2 text-patient-teal"></i>
                            Additional Information (Optional)
                        </label>
                        <textarea name="additional_info" 
                                  id="additional_info"
                                  rows="4"
                                  class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-patient-orange/50 focus:border-patient-orange transition-all duration-300 resize-none"
                                  placeholder="Any medications taken, previous similar symptoms, family history, etc."></textarea>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex flex-col sm:flex-row gap-4 mt-8 pt-6 border-t border-gray-200">
                <button type="submit" 
                        class="flex-1 sm:flex-none px-8 py-4 bg-gradient-to-r from-patient-orange to-orange-600 text-white rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-save mr-2"></i>
                    <span data-translate="Submit Symptom">Submit Symptom</span>
                </button>
                
                <a href="{% url 'patientdashboard:symptoms_list' %}" 
                   class="flex-1 sm:flex-none px-8 py-4 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-300 font-semibold text-center">
                    <i class="fas fa-times mr-2"></i>
                    <span data-translate="Cancel">Cancel</span>
                </a>
                
                <button type="button" 
                        onclick="saveDraft()"
                        class="flex-1 sm:flex-none px-8 py-4 bg-patient-blue/10 text-patient-blue rounded-xl hover:bg-patient-blue/20 transition-all duration-300 font-semibold">
                    <i class="fas fa-file-alt mr-2"></i>
                    <span data-translate="Save Draft">Save Draft</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Help Section -->
<div class="max-w-4xl mx-auto mt-8">
    <div class="bg-gradient-to-r from-patient-light-blue to-blue-50 rounded-2xl p-6">
        <h3 class="text-lg font-bold text-patient-dark-blue mb-4">
            <i class="fas fa-question-circle mr-2"></i>
            Tips for Describing Symptoms
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-semibold text-patient-blue mb-2">Be Specific</h4>
                <ul class="text-sm text-patient-dark-gray space-y-1">
                    <li>• Location of pain or discomfort</li>
                    <li>• Type of pain (sharp, dull, throbbing)</li>
                    <li>• When symptoms occur</li>
                </ul>
            </div>
            <div>
                <h4 class="font-semibold text-patient-blue mb-2">Include Context</h4>
                <ul class="text-sm text-patient-dark-gray space-y-1">
                    <li>• What triggers the symptoms</li>
                    <li>• What provides relief</li>
                    <li>• How it affects daily activities</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Character counter for symptom details
document.getElementById('details').addEventListener('input', function() {
    const charCount = this.value.length;
    document.getElementById('char-count').textContent = charCount + ' characters';
    
    // Change color based on length
    const counter = document.getElementById('char-count');
    if (charCount < 50) {
        counter.className = 'text-sm text-red-500';
    } else if (charCount < 100) {
        counter.className = 'text-sm text-yellow-500';
    } else {
        counter.className = 'text-sm text-green-500';
    }
});

// Save draft functionality
function saveDraft() {
    const formData = new FormData(document.querySelector('form'));
    localStorage.setItem('symptom_draft', JSON.stringify({
        appointment_id: formData.get('appointment_id'),
        severity: formData.get('severity'),
        duration: formData.get('duration'),
        details: formData.get('details'),
        additional_info: formData.get('additional_info'),
        timestamp: new Date().toISOString()
    }));
    
    // Show success message
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Draft Saved!';
    button.className = button.className.replace('bg-patient-blue/10 text-patient-blue', 'bg-green-100 text-green-600');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.className = button.className.replace('bg-green-100 text-green-600', 'bg-patient-blue/10 text-patient-blue');
    }, 2000);
}

// Load draft on page load
document.addEventListener('DOMContentLoaded', function() {
    const draft = localStorage.getItem('symptom_draft');
    if (draft) {
        const data = JSON.parse(draft);
        
        // Show restore option
        const restoreDiv = document.createElement('div');
        restoreDiv.className = 'bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6';
        restoreDiv.innerHTML = `
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-semibold text-yellow-800">Draft Found</h4>
                    <p class="text-sm text-yellow-700">You have an unsaved draft from ${new Date(data.timestamp).toLocaleString()}</p>
                </div>
                <div class="space-x-2">
                    <button onclick="restoreDraft()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors text-sm">
                        Restore Draft
                    </button>
                    <button onclick="clearDraft()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors text-sm">
                        Discard
                    </button>
                </div>
            </div>
        `;
        
        document.querySelector('form').insertBefore(restoreDiv, document.querySelector('form').firstChild);
    }
    
    // Initialize form animations
    const formElements = document.querySelectorAll('input, select, textarea');
    formElements.forEach((element, index) => {
        element.style.opacity = '0';
        element.style.transform = 'translateY(20px)';
        element.style.transition = 'all 0.5s ease';
        
        setTimeout(() => {
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, index * 100);
    });
});

// Restore draft function
function restoreDraft() {
    const draft = JSON.parse(localStorage.getItem('symptom_draft'));
    
    if (draft.appointment_id) document.getElementById('appointment_id').value = draft.appointment_id;
    if (draft.severity) document.querySelector(`input[value="${draft.severity}"]`).checked = true;
    if (draft.duration) document.getElementById('duration').value = draft.duration;
    if (draft.details) document.getElementById('details').value = draft.details;
    if (draft.additional_info) document.getElementById('additional_info').value = draft.additional_info;
    
    // Update character count
    document.getElementById('details').dispatchEvent(new Event('input'));
    
    // Remove restore notification
    document.querySelector('.bg-yellow-50').remove();
}

// Clear draft function
function clearDraft() {
    localStorage.removeItem('symptom_draft');
    document.querySelector('.bg-yellow-50').remove();
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const details = document.getElementById('details').value.trim();
    
    if (details.length < 20) {
        e.preventDefault();
        alert('Please provide more detailed information about your symptoms (at least 20 characters).');
        document.getElementById('details').focus();
        return false;
    }
    
    // Clear draft on successful submission
    localStorage.removeItem('symptom_draft');
});
</script>
{% endblock %}

