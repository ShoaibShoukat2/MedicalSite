{% extends 'patientdashboard/patient_base.html' %}
{% load static %}

{% block title %}Chat - Patient Dashboard{% endblock %}

{% block content %}
<style>
/* Custom animations */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-slide-in {
    animation: slideIn 0.4s ease-out;
}

@keyframes pulse-ring {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
    }
}

.pulse-ring {
    animation: pulse-ring 2s ease-in-out infinite;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px);
    }
    50% {
        transform: translateY(-10px);
    }
}

.float-animation {
    animation: float 3s ease-in-out infinite;
}

.chat-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.chat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
}

.chat-card:hover::before {
    left: 100%;
}

.chat-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(59, 130, 246, 0.3);
}

/* Gradient text */
.gradient-text {
    background: linear-gradient(135deg, #0066CC 0%, #004499 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Badge glow */
@keyframes badge-glow {
    0%, 100% {
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
    }
    50% {
        box-shadow: 0 0 25px rgba(16, 185, 129, 0.8);
    }
}

.badge-glow {
    animation: badge-glow 2s ease-in-out infinite;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .chat-card:hover {
        transform: translateY(-4px) scale(1.01);
    }
    
    .mobile-hide {
        display: none !important;
    }
}

/* Line clamp utility */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-4 sm:py-6 lg:py-8 px-3 sm:px-4 lg:px-8">
    <div class="max-w-7xl mx-auto">
        <!-- Enhanced Header with Stats - Fully Responsive -->
        <div class="bg-gradient-to-r from-patient-blue via-blue-600 to-indigo-700 rounded-2xl sm:rounded-3xl shadow-2xl mb-6 sm:mb-8 overflow-hidden animate-slide-in">
            <div class="px-4 py-6 sm:px-6 sm:py-8 lg:px-10 lg:py-10">
                <div class="flex flex-col space-y-4 lg:flex-row lg:items-center lg:justify-between lg:space-y-0 gap-4 lg:gap-6">
                    <div class="flex items-start sm:items-center space-x-3 sm:space-x-5">
                        <div class="bg-white bg-opacity-20 backdrop-blur-xl rounded-xl sm:rounded-2xl p-3 sm:p-5 shadow-2xl flex-shrink-0">
                            <i class="fas fa-comment-medical text-3xl sm:text-4xl lg:text-5xl text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-extrabold text-white mb-1 sm:mb-2 tracking-tight" data-translate="My Messages">My Messages</h1>
                            <p class="text-blue-100 text-sm sm:text-base lg:text-lg flex items-center font-medium">
                                <i class="fas fa-shield-alt mr-2 text-green-300"></i>
                                <span class="hidden sm:inline" data-translate="Secure, encrypted communication with your doctors">Secure, encrypted communication with your doctors</span>
                                <span class="sm:hidden" data-translate="Secure messaging">Secure messaging</span>
                            </p>
                            <div class="flex flex-wrap items-center gap-2 mt-2 sm:mt-3">
                                <span class="text-white text-xs sm:text-sm bg-white bg-opacity-20 px-2 sm:px-3 py-1 rounded-full">
                                    <i class="fas fa-comments mr-1"></i>
                                    {{ existing_chats|length }} Chat{{ existing_chats|length|pluralize }}
                                </span>
                                <span class="text-white text-xs sm:text-sm bg-white bg-opacity-20 px-2 sm:px-3 py-1 rounded-full mobile-hide">
                                    <i class="fas fa-clock mr-1"></i>
                                    24/7 Available
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-row sm:flex-col gap-2 sm:gap-3">
                        <span class="inline-flex items-center justify-center px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl text-xs sm:text-sm font-bold bg-green-500 text-white shadow-xl badge-glow flex-1 sm:flex-none">
                            <i class="fas fa-check-circle mr-1 sm:mr-2 text-sm sm:text-lg"></i>
                            <span class="hidden sm:inline">HIPAA Compliant</span>
                            <span class="sm:hidden">HIPAA</span>
                        </span>
                        <span class="inline-flex items-center justify-center px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl text-xs sm:text-sm font-bold bg-white text-patient-blue shadow-xl flex-1 sm:flex-none">
                            <i class="fas fa-lock mr-1 sm:mr-2"></i>
                            <span class="hidden sm:inline">Encrypted</span>
                            <span class="sm:hidden">Secure</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Wave decoration - Hidden on mobile -->
            <div class="relative h-6 sm:h-8 bg-white mobile-hide">
                <svg class="absolute bottom-0 w-full h-6 sm:h-8" viewBox="0 0 1440 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0 48h1440V0c-240 48-480 48-720 24C480 0 240 0 0 24v24z" fill="url(#wave-gradient)"/>
                    <defs>
                        <linearGradient id="wave-gradient" x1="0" y1="0" x2="1440" y2="0">
                            <stop offset="0%" stop-color="#3B82F6"/>
                            <stop offset="50%" stop-color="#2563EB"/>
                            <stop offset="100%" stop-color="#4F46E5"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
        </div>

        <!-- Chat List -->
        {% if existing_chats %}
            <div class="mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center px-2 sm:px-0">
                    <span class="gradient-text" data-translate="Active Conversations">Active Conversations</span>
                    <span class="ml-2 sm:ml-3 bg-patient-blue text-white text-xs sm:text-sm px-2 sm:px-3 py-1 rounded-full">{{ existing_chats|length }}</span>
                </h2>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                {% for chat in existing_chats %}
                <div class="chat-card bg-white rounded-xl sm:rounded-2xl shadow-lg overflow-hidden cursor-pointer animate-slide-in border-2 border-transparent hover:border-patient-blue"
                     onclick="openChatRoom({{ chat.id }})"
                     style="animation-delay: {{ forloop.counter0|multiply:0.1 }}s;">
                    
                    <!-- Card Header with Gradient -->
                    <div class="bg-gradient-to-r from-patient-blue to-indigo-600 p-3 sm:p-4">
                        <div class="flex items-center justify-between text-xs sm:text-sm">
                            <span class="text-white font-semibold bg-white bg-opacity-20 px-2 sm:px-3 py-1 rounded-full">
                                <i class="fas fa-user-md mr-1"></i>
                                <span class="hidden sm:inline">Healthcare Provider</span>
                                <span class="sm:hidden">Doctor</span>
                            </span>
                            <span class="text-white">
                                <i class="fas fa-clock mr-1"></i>
                                <span class="hidden sm:inline">{{ chat.updated_at|timesince }} ago</span>
                                <span class="sm:hidden">{{ chat.updated_at|timesince|truncatewords:1 }}</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-4 sm:p-6">
                        <!-- Doctor Info -->
                        <div class="flex items-start space-x-3 sm:space-x-4 mb-4 sm:mb-5">
                            <div class="relative flex-shrink-0">
                                {% if chat.practitioner.photo %}
                                    <img src="{{ chat.practitioner.photo.url }}" 
                                         alt="Dr. {{ chat.practitioner.first_name }}"
                                         class="w-16 h-16 sm:w-20 sm:h-20 rounded-xl sm:rounded-2xl object-cover border-3 sm:border-4 border-patient-blue shadow-xl">
                                {% else %}
                                    <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-xl sm:rounded-2xl bg-gradient-to-br from-patient-blue to-indigo-600 flex items-center justify-center shadow-xl border-3 sm:border-4 border-white">
                                        <i class="fas fa-user-md text-white text-2xl sm:text-3xl"></i>
                                    </div>
                                {% endif %}
                                <span class="absolute -bottom-1 -right-1 block h-5 w-5 sm:h-6 sm:w-6 rounded-full bg-green-400 ring-3 sm:ring-4 ring-white pulse-ring"></span>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg sm:text-xl font-extrabold text-gray-900 mb-1 truncate">
                                    Dr. {{ chat.practitioner.first_name }} {{ chat.practitioner.last_name }}
                                </h3>
                                <p class="text-xs sm:text-sm text-patient-blue font-bold mb-2 flex items-center truncate">
                                    <i class="fas fa-stethoscope mr-1"></i>
                                    {{ chat.practitioner.doctor_type|default:"General Practice" }}
                                </p>
                                <div class="flex flex-wrap items-center gap-1 sm:gap-2">
                                    <span class="inline-flex items-center text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-semibold">
                                        <span class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-green-500 rounded-full mr-1 animate-pulse"></span>
                                        Online
                                    </span>
                                    <span class="inline-flex items-center text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-semibold mobile-hide">
                                        <i class="fas fa-check-double mr-1"></i>
                                        Verified
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Last Message Preview -->
                        {% with last_message=chat.last_messages.0 %}
                            {% if last_message %}
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg sm:rounded-xl p-3 sm:p-4 mb-3 sm:mb-4 border-l-3 sm:border-l-4 border-patient-blue">
                                    <div class="flex items-start space-x-2">
                                        <i class="fas fa-comment-dots text-patient-blue mt-0.5 sm:mt-1 text-sm sm:text-base"></i>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-xs sm:text-sm text-gray-700 line-clamp-2 leading-relaxed">
                                                {% if last_message.sender_type == 'patient' %}
                                                    <span class="font-bold text-patient-blue">You:</span>
                                                {% else %}
                                                    <span class="font-bold text-green-600">Doctor:</span>
                                                {% endif %}
                                                {{ last_message.content|truncatewords:15 }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="bg-gray-50 rounded-lg sm:rounded-xl p-3 sm:p-4 mb-3 sm:mb-4 border-2 border-dashed border-gray-300">
                                    <p class="text-xs sm:text-sm text-gray-500 italic text-center">
                                        <i class="fas fa-envelope-open-text mr-2"></i>
                                        <span class="hidden sm:inline">No messages yet. Start the conversation!</span>
                                        <span class="sm:hidden">Start chatting!</span>
                                    </p>
                                </div>
                            {% endif %}
                        {% endwith %}

                        <!-- Action Button -->
                        <button class="w-full bg-gradient-to-r from-patient-blue to-indigo-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg sm:rounded-xl hover:from-patient-dark-blue hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-2xl transform hover:scale-105 flex items-center justify-center group text-sm sm:text-base">
                            <i class="fas fa-comment-dots mr-2 text-base sm:text-lg group-hover:animate-bounce"></i>
                            <span data-translate="Open Chat">Open Chat</span>
                            <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- No Chats Available -->
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden animate-slide-in">
                <div class="p-12 text-center">
                    <!-- Animated Icon -->
                    <div class="mb-8 float-animation">
                        <div class="inline-flex items-center justify-center w-40 h-40 bg-gradient-to-br from-patient-blue via-blue-500 to-indigo-600 rounded-full shadow-2xl mb-6 relative">
                            <i class="fas fa-comments text-white text-6xl"></i>
                            <div class="absolute inset-0 rounded-full bg-white opacity-20 animate-ping"></div>
                        </div>
                    </div>
                    
                    <h2 class="text-4xl font-extrabold mb-4">
                        <span class="gradient-text" data-translate="No Conversations Yet">No Conversations Yet</span>
                    </h2>
                    <p class="text-xl text-gray-600 mb-8 max-w-2xl mx-auto leading-relaxed" data-translate="Start chatting with your healthcare providers after your appointments are accepted.">
                        Start chatting with your healthcare providers after your appointments are accepted.
                    </p>

                    {% if practitioners %}
                        <div class="mb-10">
                            <h3 class="text-3xl font-bold text-gray-900 mb-2" data-translate="Available Doctors">Available Doctors</h3>
                            <p class="text-gray-600 mb-8" data-translate="Click on any doctor to start a conversation">Click on any doctor to start a conversation</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
                                {% for practitioner in practitioners %}
                                <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 rounded-2xl p-6 hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:scale-105 border-2 border-transparent hover:border-patient-blue"
                                     onclick="startNewChat({{ practitioner.id }}, 'Dr. {{ practitioner.first_name|escapejs }} {{ practitioner.last_name|escapejs }}')">
                                    <div class="flex flex-col items-center mb-4">
                                        {% if practitioner.photo %}
                                            <img src="{{ practitioner.photo.url }}" 
                                                 class="w-24 h-24 rounded-2xl object-cover border-4 border-patient-blue shadow-xl mb-4">
                                        {% else %}
                                            <div class="w-24 h-24 rounded-2xl bg-gradient-to-br from-patient-blue to-indigo-600 flex items-center justify-center shadow-xl mb-4 border-4 border-white">
                                                <i class="fas fa-user-md text-white text-4xl"></i>
                                            </div>
                                        {% endif %}
                                        <div class="text-center">
                                            <h4 class="font-extrabold text-gray-900 text-lg mb-1">Dr. {{ practitioner.first_name }} {{ practitioner.last_name }}</h4>
                                            <p class="text-sm text-patient-blue font-bold mb-2">
                                                <i class="fas fa-stethoscope mr-1"></i>
                                                {{ practitioner.doctor_type|default:"General Practice" }}
                                            </p>
                                            <div class="flex items-center justify-center gap-2 mb-3">
                                                <span class="inline-flex items-center text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-semibold">
                                                    <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                                                    Available
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="w-full bg-gradient-to-r from-patient-blue to-indigo-600 text-white font-bold py-3 px-4 rounded-xl hover:from-patient-dark-blue hover:to-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center justify-center group">
                                        <i class="fas fa-comment-medical mr-2 group-hover:animate-bounce"></i>
                                        <span data-translate="Start Chat">Start Chat</span>
                                        <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-patient-blue rounded-3xl p-10 max-w-3xl mx-auto mb-8 shadow-xl">
                            <div class="mb-6">
                                <i class="fas fa-info-circle text-patient-blue text-5xl mb-4"></i>
                            </div>
                            <p class="text-gray-700 text-xl mb-8 leading-relaxed">
                                You need to have an accepted appointment with a doctor before you can start chatting.
                            </p>
                            <a href="{% url 'patientdashboard:appointments_patients' %}" 
                               class="inline-flex items-center px-10 py-5 bg-gradient-to-r from-patient-blue to-indigo-600 text-white font-extrabold text-lg rounded-2xl hover:from-patient-dark-blue hover:to-indigo-700 transition-all duration-300 shadow-2xl hover:shadow-3xl transform hover:scale-105 group">
                                <i class="fas fa-calendar-plus mr-3 text-2xl group-hover:animate-bounce"></i>
                                <span>Book an Appointment</span>
                                <i class="fas fa-arrow-right ml-3 transform group-hover:translate-x-2 transition-transform"></i>
                            </a>
                        </div>
                    {% endif %}

                    <!-- Features -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto mt-12">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                            <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <i class="fas fa-lock text-white text-2xl"></i>
                            </div>
                            <h4 class="font-extrabold text-gray-900 text-lg mb-2">Secure</h4>
                            <p class="text-sm text-gray-600 leading-relaxed">End-to-end encrypted messages for your privacy</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                            <div class="w-16 h-16 bg-gradient-to-br from-patient-blue to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <i class="fas fa-clock text-white text-2xl"></i>
                            </div>
                            <h4 class="font-extrabold text-gray-900 text-lg mb-2">Real-time</h4>
                            <p class="text-sm text-gray-600 leading-relaxed">Instant message delivery and notifications</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <i class="fas fa-shield-alt text-white text-2xl"></i>
                            </div>
                            <h4 class="font-extrabold text-gray-900 text-lg mb-2">HIPAA Compliant</h4>
                            <p class="text-sm text-gray-600 leading-relaxed">Fully compliant with healthcare regulations</p>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-3xl p-10 text-center shadow-2xl max-w-sm mx-4">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-patient-blue mx-auto mb-6"></div>
        <p class="text-gray-700 font-bold text-lg">Opening conversation...</p>
        <p class="text-gray-500 text-sm mt-2">Please wait</p>
    </div>
</div>

<script>
function openChatRoom(chatId) {
    showLoading();
    // Redirect to the chat room page
    window.location.href = `/chat/room/${chatId}/`;
}

function startNewChat(practitionerId, doctorName) {
    const btn = event.currentTarget;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating chat...';
    btn.style.pointerEvents = 'none';
    
    showLoading();
    
    // Create new chat room
    fetch('/patient-dashboard/api/chat-room/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            'practitioner_id': practitionerId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to the chat room
            window.location.href = `/chat/room/${data.chat_room_id}/`;
        } else {
            hideLoading();
            showNotification('Error creating chat: ' + (data.error || 'Unknown error'), 'error');
            btn.innerHTML = originalHTML;
            btn.style.pointerEvents = 'auto';
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error creating chat. Please try again.', 'error');
        btn.innerHTML = originalHTML;
        btn.style.pointerEvents = 'auto';
    });
}

function showLoading() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function hideLoading() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    
    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform translate-x-full transition-transform duration-300`;
    notification.innerHTML = `
        <div class="flex items-center space-x-3">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} text-xl"></i>
            <span class="font-semibold">${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
