{% extends 'patientdashboard/patient_base.html' %}
{% load static %}
{% load dict_extras %}

{% block title %}Review Practitioners - Patient Dashboard{% endblock %}

{% block content %}
<!-- Modern Reviews Header -->
<div class="bg-gradient-to-r from-patient-pink to-pink-600 rounded-2xl p-6 mb-8 text-white">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold mb-2" data-translate="Practitioner Reviews">Practitioner Reviews</h1>
            <p class="text-white/90" data-translate="Share your experience and help other patients">Share your experience and help other patients</p>
        </div>
        <div class="mt-4 md:mt-0">
            <div class="flex items-center space-x-4">
                <div class="text-center">
                    <div class="text-2xl font-bold">{{ practitioners|length }}</div>
                    <div class="text-sm text-white/80" data-translate="To Review">To Review</div>
                </div>
                <div class="w-px h-12 bg-white/20"></div>
                <div class="text-center">
                    <div class="text-2xl font-bold">{{ reviewed_count|default:0 }}</div>
                    <div class="text-sm text-white/80" data-translate="Completed">Completed</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Messages -->
{% if messages %}
<div class="mb-6">
    {% for message in messages %}
    <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-xl mb-4 flex items-center">
        <i class="fas fa-check-circle mr-3 text-green-600"></i>
        <span>{{ message }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Reviews Grid -->
{% if practitioners %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    {% for practitioner in practitioners %}
    <div class="review-card bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden hover:shadow-xl transition-all duration-300">
        <!-- Card Header -->
        <div class="bg-gradient-to-r from-patient-light-blue to-blue-50 p-6">
            <div class="flex items-center space-x-4">
                <!-- Doctor Photo -->
                <div class="flex-shrink-0">
                    {% if practitioner.photo %}
                        <img src="{{ practitioner.photo.url }}" 
                             alt="Dr. {{ practitioner.first_name }}" 
                             class="w-20 h-20 rounded-full object-cover border-4 border-white shadow-lg">
                    {% else %}
                        <div class="w-20 h-20 rounded-full bg-gradient-to-br from-patient-blue to-patient-dark-blue flex items-center justify-center border-4 border-white shadow-lg">
                            <i class="fas fa-user-md text-white text-xl"></i>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Doctor Info -->
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-patient-dark-blue mb-1">
                        Dr. {{ practitioner.first_name }} {{ practitioner.last_name }}
                    </h3>
                    <p class="text-patient-dark-gray mb-2">{{ practitioner.get_specialty_display }}</p>
                    <div class="flex items-center space-x-2">
                        <span class="px-3 py-1 bg-patient-blue/10 text-patient-blue rounded-full text-sm font-medium">
                            <i class="fas fa-stethoscope mr-1"></i>Specialist
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Content -->
        <div class="p-6">
            {% with patient_review=patient_reviews|dict_get:practitioner.id %}
                {% if patient_review %}
                    <!-- Already Reviewed -->
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <h4 class="font-semibold text-green-800">Review Completed</h4>
                        </div>
                        
                        <!-- Star Rating Display -->
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="flex text-yellow-400">
                                {% for star in "12345"|make_list %}
                                    {% if forloop.counter <= patient_review.rating %}
                                        <i class="fas fa-star text-lg"></i>
                                    {% else %}
                                        <i class="far fa-star text-lg"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="text-sm text-patient-dark-gray font-medium">{{ patient_review.rating }}/5 stars</span>
                        </div>
                        
                        <!-- Feedback -->
                        <div class="mb-3">
                            <h5 class="font-medium text-patient-dark-blue mb-2">Your Feedback:</h5>
                            <p class="text-patient-dark-gray text-sm bg-white p-3 rounded-lg border">
                                {{ patient_review.feedback|default:"No feedback provided." }}
                            </p>
                        </div>
                        
                        <p class="text-xs text-patient-dark-gray">
                            <i class="fas fa-calendar mr-1"></i>
                            Reviewed on {{ patient_review.created_at|date:"M d, Y" }}
                        </p>

                        <!-- Practitioner Replies -->
                        {% if patient_review.replies %}
                            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-xl p-4">
                                <h5 class="font-medium text-patient-blue mb-3">
                                    <i class="fas fa-reply mr-2"></i>Doctor's Response:
                                </h5>
                                {% for reply in patient_review.replies %}
                                    <div class="bg-white p-3 rounded-lg border mb-2 last:mb-0">
                                        <p class="text-patient-dark-gray text-sm mb-2">{{ reply.message }}</p>
                                        <p class="text-xs text-patient-dark-gray">
                                            <i class="fas fa-clock mr-1"></i>
                                            {{ reply.created_at|date:"M d, Y" }}
                                        </p>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <!-- Review Form -->
                    <form method="POST" action="{% url 'patientdashboard:review_practitioner' practitioner.id %}" class="space-y-4">
                        {% csrf_token %}
                        
                        <!-- Rating Selection -->
                        <div>
                            <label class="block text-sm font-semibold text-patient-dark-blue mb-3">
                                <i class="fas fa-star mr-2 text-yellow-400"></i>
                                Rate Your Experience
                            </label>
                            <div class="flex space-x-2">
                                {% for i in "12345"|make_list %}
                                <label class="cursor-pointer">
                                    <input type="radio" name="rating" value="{{ forloop.counter }}" class="sr-only peer" required>
                                    <div class="w-12 h-12 border-2 border-gray-200 rounded-full flex items-center justify-center peer-checked:border-yellow-400 peer-checked:bg-yellow-50 hover:border-yellow-300 transition-all duration-300 star-rating-btn" data-rating="{{ forloop.counter }}">
                                        <i class="fas fa-star text-lg text-gray-400 peer-checked:text-yellow-500 star-icon"></i>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                            <p class="text-xs text-patient-dark-gray mt-2">Click stars to rate from 1 to 5</p>
                        </div>

                        <!-- Feedback -->
                        <div>
                            <label for="feedback_{{ practitioner.id }}" class="block text-sm font-semibold text-patient-dark-blue mb-3">
                                <i class="fas fa-comment-alt mr-2 text-patient-blue"></i>
                                Your Feedback
                            </label>
                            <textarea id="feedback_{{ practitioner.id }}" 
                                      name="feedback" 
                                      rows="4"
                                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-patient-pink/50 focus:border-patient-pink transition-all duration-300 resize-none"
                                      placeholder="Share your experience with this doctor. How was the consultation? Would you recommend them to others?"></textarea>
                            <p class="text-xs text-patient-dark-gray mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Your honest feedback helps other patients make informed decisions
                            </p>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end pt-4">
                            <button type="submit" 
                                    class="px-6 py-3 bg-gradient-to-r from-patient-pink to-pink-600 text-white rounded-xl hover:from-pink-600 hover:to-pink-700 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Submit Review
                            </button>
                        </div>
                    </form>
                {% endif %}
            {% endwith %}
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<!-- Empty State -->
<div class="text-center py-16">
    <div class="w-24 h-24 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-star text-patient-pink text-4xl"></i>
    </div>
    <h3 class="text-2xl font-semibold text-patient-dark-blue mb-4">No Reviews Available</h3>
    <p class="text-patient-dark-gray mb-8 max-w-md mx-auto">
        You don't have any practitioners eligible for review yet. Complete an appointment to leave a review.
    </p>
    <a href="{% url 'patient_dashboard:specialty_selection' %}" 
       class="inline-flex items-center px-6 py-3 bg-patient-pink text-white rounded-xl hover:bg-pink-700 transition-colors font-semibold">
        <i class="fas fa-calendar-plus mr-2"></i>Book Your First Appointment
    </a>
</div>
{% endif %}

<!-- Review Guidelines -->
<div class="mt-12 bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
    <h3 class="text-lg font-bold text-patient-dark-blue mb-4">
        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
        Review Guidelines
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-thumbs-up text-green-600"></i>
            </div>
            <h4 class="font-semibold text-patient-dark-blue mb-2">Be Honest</h4>
            <p class="text-sm text-patient-dark-gray">Share your genuine experience to help other patients</p>
        </div>
        
        <div class="text-center">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-heart text-patient-blue"></i>
            </div>
            <h4 class="font-semibold text-patient-dark-blue mb-2">Be Respectful</h4>
            <p class="text-sm text-patient-dark-gray">Keep your feedback constructive and professional</p>
        </div>
        
        <div class="text-center">
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-shield-alt text-patient-purple"></i>
            </div>
            <h4 class="font-semibold text-patient-dark-blue mb-2">Stay Safe</h4>
            <p class="text-sm text-patient-dark-gray">Don't share personal medical information in reviews</p>
        </div>
    </div>
</div>

<script>
// Initialize review cards animation
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.review-card');
    cards.forEach((card, index) => {
        // Initial state
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'all 0.6s ease';
        
        // Animate in with stagger
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 200);
    });
});

// Enhanced star rating interaction
document.querySelectorAll('input[type="radio"][name="rating"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const value = parseInt(this.value);
        const container = this.closest('form');
        const starButtons = container.querySelectorAll('.star-rating-btn');
        
        starButtons.forEach((button, index) => {
            const starIcon = button.querySelector('.star-icon');
            
            if (index < value) {
                button.classList.add('border-yellow-400', 'bg-yellow-50');
                button.classList.remove('border-gray-200');
                starIcon.classList.add('text-yellow-500');
                starIcon.classList.remove('text-gray-400');
            } else {
                button.classList.remove('border-yellow-400', 'bg-yellow-50');
                button.classList.add('border-gray-200');
                starIcon.classList.remove('text-yellow-500');
                starIcon.classList.add('text-gray-400');
            }
        });
    });
});

// Add hover effect for star ratings
document.querySelectorAll('.star-rating-btn').forEach((button, index) => {
    button.addEventListener('mouseenter', function() {
        const container = this.closest('form');
        const starButtons = container.querySelectorAll('.star-rating-btn');
        const rating = parseInt(this.getAttribute('data-rating'));
        
        starButtons.forEach((btn, btnIndex) => {
            const starIcon = btn.querySelector('.star-icon');
            if (btnIndex < rating) {
                starIcon.classList.add('text-yellow-400');
                starIcon.classList.remove('text-gray-400');
            } else {
                starIcon.classList.remove('text-yellow-400');
                starIcon.classList.add('text-gray-400');
            }
        });
    });
    
    button.addEventListener('mouseleave', function() {
        const container = this.closest('form');
        const checkedRadio = container.querySelector('input[name="rating"]:checked');
        const starButtons = container.querySelectorAll('.star-rating-btn');
        
        if (checkedRadio) {
            const checkedValue = parseInt(checkedRadio.value);
            starButtons.forEach((btn, btnIndex) => {
                const starIcon = btn.querySelector('.star-icon');
                if (btnIndex < checkedValue) {
                    starIcon.classList.add('text-yellow-500');
                    starIcon.classList.remove('text-gray-400', 'text-yellow-400');
                } else {
                    starIcon.classList.remove('text-yellow-500', 'text-yellow-400');
                    starIcon.classList.add('text-gray-400');
                }
            });
        } else {
            starButtons.forEach(btn => {
                const starIcon = btn.querySelector('.star-icon');
                starIcon.classList.remove('text-yellow-400', 'text-yellow-500');
                starIcon.classList.add('text-gray-400');
            });
        }
    });
});

// Form validation
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const rating = this.querySelector('input[name="rating"]:checked');
        const feedback = this.querySelector('textarea[name="feedback"]').value.trim();
        
        if (!rating) {
            e.preventDefault();
            alert('Please select a rating before submitting your review.');
            return false;
        }
        
        if (feedback.length < 10) {
            e.preventDefault();
            alert('Please provide more detailed feedback (at least 10 characters).');
            this.querySelector('textarea[name="feedback"]').focus();
            return false;
        }
    });
});
</script>
{% endblock %}
