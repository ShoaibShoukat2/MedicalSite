{% extends 'patientdashboard/patient_base.html' %}
{% load static %}
{% load dict_extras %}

{% block title %}Review Practitioners{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-5 fw-bold">Your Practitioner Reviews</h2>

    <!-- Global message display -->
    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if practitioners %}
        <div class="row g-4">
            {% for practitioner in practitioners %}
                <div class="col-lg-6 col-md-12">
                    <div class="card shadow-sm border-0 rounded-4 overflow-hidden h-100">
                        <div class="row g-0">
                            <div class="col-4 d-flex align-items-center justify-content-center bg-light p-3">
                                {% if practitioner.photo %}
                                    <img src="{{ practitioner.photo.url }}" alt="Profile Photo" class="rounded-circle img-fluid" style="width: 100px; height: 100px; object-fit: cover;">
                                {% else %}
                                    <img src="{% static 'default-avatar.png' %}" alt="Default Profile" class="rounded-circle img-fluid" style="width: 100px; height: 100px; object-fit: cover;">
                                {% endif %}
                            </div>
                            <div class="col-8 p-4 d-flex flex-column justify-content-between">
                                <div>
                                    <h4 class="mb-1">{{ practitioner.first_name }} {{ practitioner.last_name }}</h4>
                                    <p class="text-secondary fst-italic mb-3">Specialization: {{ practitioner.get_specialty_display }}</p>

                                    {% with patient_review=patient_reviews|dict_get:practitioner.id %}
                                        {% if patient_review %}
                                            <!-- Already Reviewed -->
                                            <div class="border-start ps-3 mb-3">
                                                <h6 class="fw-bold mb-2 text-success">✔️ You have already reviewed this practitioner</h6>
                                                <div class="mb-2">
                                                    {% for star in "12345"|make_list %}
                                                        {% if star <= patient_review.rating|stringformat:"s" %}
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                        {% else %}
                                                            <i class="bi bi-star text-muted"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <p class="mb-1"><strong>Feedback:</strong> {{ patient_review.feedback|default:"No feedback provided." }}</p>
                                                <small class="text-muted">Reviewed on {{ patient_review.created_at|date:"M d, Y" }}</small>

                                                {% if patient_review.replies %}
                                                    <div class="mt-3 ps-3 border-start border-primary">
                                                        <h6 class="fw-semibold text-primary mb-2">Practitioner Reply:</h6>
                                                        {% for reply in patient_review.replies %}

                                                        
                                                            
                                                                <div class="mb-2 p-2 bg-light rounded">
                                                                    <p class="mb-1">{{ reply.message }}</p>
                                                                    <small class="text-muted">Replied on {{ reply.created_at|date:"M d, Y" }}</small>
                                                                </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <!-- Show Review Form -->
                                            <form method="POST" action="{% url 'patientdashboard:review_practitioner' practitioner.id %}" class="mt-2">
                                                {% csrf_token %}
                                                <label for="rating_{{ practitioner.id }}" class="form-label fw-semibold">Rating</label>
                                                <select id="rating_{{ practitioner.id }}" name="rating" class="form-select mb-3" required>
                                                    {% for i in "12345"|make_list %}
                                                        <option value="{{ i }}">{{ i }} Star{% if i != "1" %}s{% endif %}</option>
                                                    {% endfor %}
                                                </select>

                                                <label for="feedback_{{ practitioner.id }}" class="form-label fw-semibold">Feedback</label>
                                                <textarea id="feedback_{{ practitioner.id }}" name="feedback" rows="3" class="form-control mb-3" placeholder="Write your feedback..."></textarea>

                                                <div class="text-end">
                                                    <button type="submit" class="btn btn-primary px-4">Submit Review</button>
                                                </div>
                                            </form>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info text-center shadow-sm mt-5">
            You don't have any practitioners eligible for review.
        </div>
    {% endif %}
</div>
{% endblock %}
